<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Johngo Blog</title>
  
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://github.com/zhuangxq/zhuangxq.github.io.git/"/>
  <updated>2020-02-03T09:34:27.760Z</updated>
  <id>https://github.com/zhuangxq/zhuangxq.github.io.git/</id>
  
  <author>
    <name>Johngo</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>ã€ŠObjective-C é«˜çº§ç¼–ç¨‹ã€‹ç¬”è®°ä¸€ è‡ªåŠ¨å¼•ç”¨è®¡æ•°</title>
    <link href="https://github.com/zhuangxq/zhuangxq.github.io.git/2020/02/03/%E8%87%AA%E5%8A%A8%E5%BC%95%E7%94%A8%E8%AE%A1%E6%95%B0/"/>
    <id>https://github.com/zhuangxq/zhuangxq.github.io.git/2020/02/03/è‡ªåŠ¨å¼•ç”¨è®¡æ•°/</id>
    <published>2020-02-03T08:58:08.000Z</published>
    <updated>2020-02-03T09:34:27.760Z</updated>
    
    <content type="html"><![CDATA[<p>å‰è¨€ï¼Œä¹…ä»°ã€ŠObjective-Cé«˜çº§ç¼–ç¨‹ iOSä¸OS Xå¤šçº¿ç¨‹å’Œå†…å­˜ç®¡ç†ã€‹è¿™æœ¬ä¹¦å¤§åï¼Œè¶ç€æ”¾å‡å­¦ä¹ ä¸€ä¸‹ã€‚ä¸»è¦å†…å®¹æœ‰ä¸‰å—ï¼šè‡ªåŠ¨å¼•ç”¨è®¡æ•°ã€Blocksã€GCDã€‚å†…å®¹ä¸å¤šï¼Œä½†æ˜¯è®²å¾—æ¯”è¾ƒæ·±å…¥ï¼Œä¸”æ˜¯iOSåŸºç¡€çŸ¥è¯†ï¼Œå€¼å¾—è¯¦ç»†é˜…è¯»ã€‚æœ¬æ–‡ä¸ºè‡ªåŠ¨å¼•ç”¨éƒ¨åˆ†çš„ä¸€äº›ç¬”è®°ã€‚</p><a id="more"></a><h4 id="å¼•ç”¨è®¡æ•°">å¼•ç”¨è®¡æ•°</h4><p>allocåˆ›å»º, retainæŒæœ‰, releaseé‡Šæ”¾, deallocåºŸå¼ƒï¼Œä¸€ä¸ªå¯¹è±¡åˆ›å»ºå¹¶æŒæœ‰+1ï¼ŒæŒæœ‰+1ï¼Œrelease-1ï¼Œå¼•ç”¨è®¡æ•°ä¸º0æ—¶deallocã€‚</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åˆ›å»ºä¸”æŒæœ‰å¯¹è±¡</span></span><br><span class="line"><span class="keyword">id</span> obj = [<span class="built_in">NSObject</span> new];</span><br><span class="line"></span><br><span class="line"><span class="comment">// é‡Šæ”¾</span></span><br><span class="line">[obj release];</span><br><span class="line"></span><br><span class="line"><span class="comment">// å–å¾—å¯¹è±¡ï¼Œä½†è‡ªå·±ä¸æŒæœ‰</span></span><br><span class="line"><span class="keyword">id</span> array = [<span class="built_in">NSMutableArray</span> array];</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ²¡æœ‰æŒæœ‰ï¼Œæ‰€ä»¥ä¸èƒ½é‡Šæ”¾</span></span><br><span class="line">[array release]; <span class="comment">// ä¼šè¹¦</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// æŒæœ‰å¯¹è±¡</span></span><br><span class="line">[array <span class="keyword">retain</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">// æŒæœ‰å¯¹è±¡äº†ï¼Œéœ€è¦é‡Šæ”¾</span></span><br><span class="line">[array release];</span><br></pre></td></tr></table></figure><p>[NSMutableArray array]ä¸ºä»€ä¹ˆåˆ›å»ºçš„å¯¹è±¡å­˜åœ¨ï¼Œä½†æ˜¯æ²¡æœ‰æŒæœ‰å‘¢ï¼Ÿå› ä¸ºé‡Œé¢è°ƒäº†autorelase</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">- (<span class="keyword">id</span>)array &#123;</span><br><span class="line">    <span class="keyword">id</span> obj = [[<span class="built_in">NSMutableArray</span> alloc] init];</span><br><span class="line">    [obj autorelease];</span><br><span class="line">    <span class="keyword">return</span> obj;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¼•ç”¨è®¡æ•°é‡‡ç”¨æ•£åˆ—è¡¨æ¥ç®¡ç†å¼•ç”¨è®¡æ•°<br><img src="/images/è‡ªåŠ¨å¼•ç”¨è®¡æ•°/15806399286271.jpg" alt></p><h4 id="autorelease_å®ç°">autorelease å®ç°</h4><p>autoreleaseå¯ä»¥ä½¿å¯¹è±¡åœ¨è¶…å‡ºæŒ‡å®šçš„ç”Ÿå­˜èŒƒå›´æ—¶èƒ½å¤Ÿè‡ªåŠ¨å¹¶æ­£ç¡®åœ°é‡Šæ”¾(è°ƒç”¨releaseæ–¹æ³•)ã€‚<br><img src="/images/è‡ªåŠ¨å¼•ç”¨è®¡æ•°/15736159643763.jpg" alt></p><p>autoreleaseå®ä¾‹æ–¹æ³•çš„æœ¬è´¨å°±æ˜¯è°ƒç”¨NSAutoreleasePoolå¯¹è±¡çš„addObjectç±»æ–¹æ³•</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">id</span>)autorelease &#123;</span><br><span class="line">    [<span class="built_in">NSAutoReleasePool</span> addObject:<span class="keyword">self</span>]; <span class="comment">//å®é™…è¿™ä¸ªæ–¹æ³•æ˜¯æœ‰IMPç¼“å­˜ï¼Œå»æ‰æŸ¥æ‰¾è¿‡ç¨‹ï¼Œç›´æ¥æ‰§è¡Œçš„</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (<span class="keyword">void</span>)addObject:(<span class="keyword">id</span>)anObj &#123;</span><br><span class="line">    <span class="built_in">NSAutoReleasePool</span> *pool = å–å¾—æ­£åœ¨ä½¿ç”¨çš„<span class="built_in">NSAutoReleasePool</span>å¯¹è±¡;</span><br><span class="line">    <span class="keyword">if</span> (pool != <span class="literal">nil</span>) &#123;</span><br><span class="line">        [pool addOjbect:anObj];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"NSAutoReleasePoolå¯¹è±¡éå­˜åœ¨çŠ¶æ€ä¸‹è°ƒç”¨autorelease"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)addObject:(<span class="keyword">id</span>)anObj &#123;</span><br><span class="line">    [array addObject:anObj];    <span class="comment">// å†…éƒ¨æ•°ç»„</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)drain &#123;</span><br><span class="line">    [<span class="keyword">self</span> dealloc];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)dealloc &#123;</span><br><span class="line">    [<span class="keyword">self</span> emptyPool];</span><br><span class="line">    [array release];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)emptyPool &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">id</span> obj <span class="keyword">in</span> array) &#123;</span><br><span class="line">        [obj release];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢æ˜¯GNUStepçš„autoreleaseå®ç°ï¼Œè‹¹æœçš„å…·ä½“å®ç°æ˜¯å½¢å¼ä¸å¤ªä¸€æ ·ï¼ŒC++å®ç°ï¼Œæµç¨‹æœ¬è´¨æ˜¯ä¸€æ ·çš„ã€‚</p><h4 id="ARC">ARC</h4><p>ARCæœ‰æ•ˆæ—¶ï¼Œå…¶ç±»å‹ä¸Šå¿…é¡»é™„åŠ æ‰€æœ‰æƒä¿®é¥°ç¬¦ã€‚æ€»å…±å››ä¸ªæ‰€æœ‰æƒä¿®é¥°ç¬¦ï¼š</p><ul><li>__strongï¼šé»˜è®¤ä¿®é¥°ç¬¦</li><li>__weak</li><li>__unsafe_unretained</li><li>__autoreleasing</li></ul><h5 id="__strong">__strong</h5><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// ARCæœ‰æ•ˆ</span></span><br><span class="line">&#123;</span><br><span class="line">   <span class="comment">// __strongä¿®é¥°ç¬¦çš„å˜é‡objcåœ¨è¶…å‡ºå…¶å˜é‡ä½œç”¨åŸŸæ—¶ï¼Œå³åœ¨è¯¥å˜é‡è¢«åºŸå¼ƒæ—¶ï¼Œä¼šé‡Šæ”¾å…¶è¢«èµ‹äºˆçš„å¯¹è±¡</span></span><br><span class="line">   <span class="keyword">id</span> __<span class="keyword">strong</span> obj = [[<span class="built_in">NSObject</span> alloc] init];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ARCæ— æ•ˆ</span></span><br><span class="line">&#123;</span><br><span class="line">   <span class="keyword">id</span> obj = [[<span class="built_in">NSObject</span> alloc] init];</span><br><span class="line">   [obj release];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>strongä¿®é¥°ç¬¦è¡¨ç¤ºå¯¹å¯¹è±¡çš„â€œå¼ºå¼•ç”¨â€ã€‚æŒæœ‰å¼ºå¼•ç”¨çš„å˜é‡åœ¨è¶…å‡ºå…¶ä½œç”¨åŸŸæ—¶è¢«åºŸå¼ƒï¼Œéšç€å¼ºå¼•ç”¨çš„å¤±æ•ˆï¼Œå¼•ç”¨çš„å¯¹è±¡ä¼šéšä¹‹é‡Šæ”¾ã€‚ä¸”ï¼Œåœ¨èµ‹å€¼ä¸Šä¹Ÿèƒ½å¤Ÿæ­£ç¡®çš„ç®¡ç†å…¶å¯¹è±¡çš„æ‰€æœ‰è€…ï¼Œèµ‹æ–°å€¼ï¼Œæ—§å€¼çŠ¹å¦‚è¶…å‡ºä½œç”¨åŸŸä¸€æ ·ï¼Œä¼šè¢«é‡Šæ”¾ã€‚è¿˜æœ‰ä¸€ä¸ªæƒ…å†µï¼Œå¯¹è±¡åºŸå¼ƒï¼Œå¯¹è±¡æ‰€å±çš„æˆå‘˜å˜é‡ä¹Ÿä¼šåºŸå¼ƒã€‚ é€šè¿‡</strong>strongä¿®é¥°ç¬¦ï¼Œä¸å¿…å†æ¬¡é”®å…¥retainæˆ–è€…releaseã€‚</p><h5 id="__weak">__weak</h5><p><strong>strongäº’ç›¸å¼•ç”¨çš„æ—¶å€™ï¼Œä¼šå‡ºç°å¾ªç¯å¼•ç”¨ï¼Œå¯¼è‡´æ— æ³•é‡Šæ”¾ã€‚</strong>weakæä¾›å¼±å¼•ç”¨ï¼Œå¼±å¼•ç”¨ä¸èƒ½æŒæœ‰å¯¹è±¡çš„å®ä¾‹ã€‚</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="comment">// è‡ªå·±ç”Ÿæˆå¹¶æŒæœ‰å¯¹è±¡</span></span><br><span class="line">    <span class="keyword">id</span> __<span class="keyword">strong</span> obj0 = [[<span class="built_in">NSObject</span> alloc] init];</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">id</span> __<span class="keyword">weak</span> obj1 = obj0;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// objc1 å˜é‡æŒæœ‰ç”Ÿæˆå¯¹è±¡çš„å¼±å¼•ç”¨</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//  å› ä¸ºobj0å˜é‡è¶…å‡ºå…¶ä½œç”¨åŸŸï¼Œå¼ºå¼•ç”¨å¤±æ•ˆï¼Œæ‰€ä»¥è‡ªåŠ¨é‡Šæ”¾è‡ªå·±æŒæœ‰çš„å¯¹è±¡ã€‚</span></span><br><span class="line">    <span class="comment">// objc1æ²¡æœ‰æŒæœ‰ã€‚å¯¹è±¡çš„æ‰€æœ‰è€…ä¸å­˜åœ¨ï¼Œæ‰€ä»¥åºŸå¼ƒè¯¥å¯¹è±¡ã€‚</span></span><br></pre></td></tr></table></figure><p>__weakè¿˜æœ‰å¦ä¸€ä¼˜ç‚¹ã€‚åœ¨æŒæœ‰æŸå¯¹è±¡çš„å¼±å¼•ç”¨æ—¶ï¼Œè‹¥è¯¥å¯¹è±¡è¢«åºŸå¼ƒï¼Œåˆ™æ­¤å¼±å¼•ç”¨å°†è‡ªåŠ¨å¤±æ•ˆä¸”å¤„äºnilè¢«èµ‹å€¼çš„çŠ¶æ€ï¼ˆç©ºå¼±å¼•ç”¨ï¼‰ã€‚</p><h5 id="__unsafe_unretained">__unsafe_unretained</h5><p>æ­£å¦‚å…¶åï¼Œè¿™ä¸ªæ˜¯ä¸å®‰å…¨çš„æ‰€æœ‰æƒä¿®é¥°ç¬¦ã€‚åŒ__weakä¸€æ ·ï¼Œæ˜¯ä¸æŒæœ‰å¯¹è±¡çš„ã€‚ä½†æ˜¯å¼•ç”¨çš„å¯¹è±¡å¦‚æœä¸å­˜åœ¨äº†ï¼Œä¸ä¼šç½®ç©ºå˜é‡ï¼Œå¯¼è‡´é‡æŒ‡é’ˆã€‚ç°åœ¨éƒ½ä¸éœ€è¦ä½¿ç”¨è¿™ä¸ªä¿®é¥°ç¬¦äº†ã€‚</p><h5 id="__autoreleasing">__autoreleasing</h5><p>ARCæœ‰æ•ˆæ—¶ï¼Œç”¨@autoreleasepoolå—æ›¿ä»£NSAutoReleasePoolç±»ï¼Œç”¨é™„æœ‰__autoreleasingä¿®é¥°ç¬¦çš„å˜é‡æ›¿ä»£autoreleaseæ–¹æ³•ã€‚<br><img src="/images/è‡ªåŠ¨å¼•ç”¨è®¡æ•°/15790743058541.jpg" alt></p><p>é€šå¸¸ä¸éœ€è¦æ˜¾ç¤ºçš„å†™<strong>autoreleasingï¼Œå°±åƒä¸ä¼šæ˜¾å¼åœ°ä½¿ç”¨ </strong>strongä¿®é¥°ç¬¦ä¸€æ ·ã€‚</p><ol><li>ç¼–è¯‘å™¨ä¼šæ£€æŸ¥æ–¹æ³•åæ˜¯å¦ä»¥alloc, new, copy, mutableCopy å¼€å§‹ï¼Œå¦‚æœä¸æ˜¯åˆ™è‡ªåŠ¨å°†è¿”å›å€¼çš„å¯¹è±¡æ³¨å†Œåˆ° autoreleasepool ä¸­ï¼›</li><li>è™½ç„¶<strong>weak ä¿®é¥°ç¬¦æ˜¯ä¸ºäº†é¿å…å¼ºå¼•ç”¨å¾ªç¯ï¼ˆstrong reference circleï¼‰è€Œä½¿ç”¨çš„ï¼Œä½†åœ¨è®¿é—®é™„æœ‰ </strong>weak ä¿®é¥°ç¬¦çš„å˜é‡æ—¶ï¼Œå®é™…ä¸Šå¿…å®šè¦è®¿é—®æ³¨å†Œåˆ° autoreleasepool çš„å¯¹è±¡ã€‚å› ä¸º __weak ä¿®é¥°ç¬¦åªæŒæœ‰å¯¹è±¡çš„å¼±å¼•ç”¨ï¼Œè€Œåœ¨è®¿é—®å¼•ç”¨å¯¹è±¡è¿‡ç¨‹ä¸­ï¼Œè¯¥å¯¹è±¡æœ‰å¯èƒ½è¢«åºŸå¼ƒã€‚è€Œå°†å¼±å¼•ç”¨å¯¹è±¡æ³¨å†Œåˆ° autoreleasepool ä¸­ï¼Œåœ¨ pool è¢«é”€æ¯ä¹‹å‰éƒ½èƒ½ç¡®ä¿è¯¥å¯¹è±¡å­˜åœ¨ã€‚</li><li>id çš„æŒ‡é’ˆæˆ–å¯¹è±¡çš„æŒ‡é’ˆåœ¨æ²¡æœ‰æ˜¾å¼åœ°æŒ‡å®šä¿®é¥°ç¬¦æ—¶å€™ï¼Œä¼šè¢«é»˜è®¤é™„åŠ ä¸Š__autoreleasing ä¿®é¥°ç¬¦ã€‚</li></ol><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">+ (<span class="keyword">nullable</span> <span class="keyword">instancetype</span>)stringWithContentsOfURL:(<span class="built_in">NSURL</span> *)url encoding:(<span class="built_in">NSStringEncoding</span>)enc error:(<span class="built_in">NSError</span> **)error;</span><br><span class="line"></span><br><span class="line">+ (<span class="keyword">nullable</span> <span class="keyword">instancetype</span>)stringWithContentsOfURL:(<span class="built_in">NSURL</span> *)url encoding:(<span class="built_in">NSStringEncoding</span>)enc error:(<span class="built_in">NSError</span> * __autoreleasing *)error;</span><br></pre></td></tr></table></figure><h4 id="ARCè§„åˆ™">ARCè§„åˆ™</h4><ul><li>ä¸èƒ½ä½¿ç”¨retain/release/retainCount/autorelease</li><li>ä¸èƒ½ä½¿ç”¨NSAllocateObject/NSDeallocateObject</li><li>é¡»éµå®ˆå†…å­˜ç®¡ç†çš„æ–¹æ³•å‘½åè§„åˆ™</li><li>ä¸è¦æ˜¾ç¤ºè°ƒç”¨dealloc</li><li>ä½¿ç”¨@autoreleasepool ä»£æ›¿NSAutoreleasePool</li><li>ä¸èƒ½ä½¿ç”¨åŒºåŸŸNSZone</li><li>å¯¹è±¡ç±»å‹ä¸èƒ½ä½œä¸ºCè¯­è¨€ç»“æ„ä½“(struc/union)çš„æˆå‘˜</li><li>æ˜¾ç¤ºè½¬æ¢â€idâ€å’Œâ€void*â€</li></ul><h5 id="æ˜¾ç¤ºè½¬æ¢â€idâ€å’Œâ€void*â€">æ˜¾ç¤ºè½¬æ¢â€idâ€å’Œâ€void*â€</h5><p>ARCæ— æ•ˆæ—¶ç›´æ¥è½¬æ¢ï¼ŒARCæœ‰æ•ˆé¡»é€šè¿‡bridgeè½¬ã€‚</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ARCæ— æ•ˆ</span></span><br><span class="line"><span class="keyword">id</span> obj = [[<span class="built_in">NSObject</span> alloc] init];</span><br><span class="line"><span class="keyword">void</span> *p = obj;</span><br><span class="line"><span class="keyword">id</span> o = p;</span><br><span class="line">[o release];</span><br><span class="line"></span><br><span class="line"><span class="comment">// ARCæœ‰æ•ˆ</span></span><br><span class="line"><span class="keyword">id</span> obj = [[<span class="built_in">NSObject</span> alloc] init];</span><br><span class="line"><span class="keyword">void</span> *p = (__bridge <span class="keyword">void</span>*)obj;  <span class="comment">// å®‰å…¨æ€§ä¸èµ‹å€¼ç»™__unsafe_unretainedä¿®é¥°ç¬¦ç›¸è¿‘ï¼Œç”šè‡³æ›´ä½</span></span><br><span class="line"><span class="keyword">id</span> o = (__bridge <span class="keyword">id</span>)p;</span><br></pre></td></tr></table></figure><p><strong>bridgeå¦å¤–æä¾›ä¸¤ç§è½¬æ¢, </strong>bridge_retainedå’Œ<strong>bridge_transferè½¬æ¢ã€‚</strong>bridge_retainerå¯ä½¿è¦è½¬æ¢èµ‹å€¼çš„å˜é‡ä¹ŸæŒæœ‰æ‰€è¾…åŠ©çš„å¯¹è±¡ã€‚</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ARCæ— æ•ˆ</span></span><br><span class="line"><span class="keyword">id</span> obj = [[<span class="built_in">NSObject</span> alloc] init];</span><br><span class="line"><span class="keyword">void</span> *p = obj;</span><br><span class="line">[(<span class="keyword">id</span>)p <span class="keyword">retain</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">// ARCæœ‰æ•ˆ</span></span><br><span class="line"><span class="keyword">void</span> *p = <span class="number">0</span>;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">id</span> obj = [[<span class="built_in">NSObject</span> alloc] init];</span><br><span class="line">    p = (__bridge_retainer <span class="keyword">void</span>*)obj;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/// objå¤±æ•ˆï¼Œpè¿˜æŒæœ‰å¯¹è±¡ï¼Œæ‰€ä»¥ä¸è¢«é‡Šæ”¾</span></span><br><span class="line"><span class="built_in">NSLog</span>(<span class="string">@"class = %@"</span>, [(__bridge <span class="keyword">id</span>)p <span class="keyword">class</span>]);</span><br></pre></td></tr></table></figure><p>__bridge_transferè½¬æ¢æä¾›ç›¸åçš„åŠ¨ä½œï¼Œè¢«è½¬æ¢çš„å˜é‡æ‰€æŒæœ‰çš„å¯¹è±¡åœ¨è¯¥å˜é‡è¢«èµ‹å€¼ç»™è½¬æ¢ç›®æ ‡å˜é‡åéšä¹‹é‡Šæ”¾ã€‚</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ARCæ— æ•ˆ</span></span><br><span class="line"><span class="keyword">id</span> obj = (<span class="keyword">id</span>)p;</span><br><span class="line">[obj <span class="keyword">retain</span>];</span><br><span class="line">[(<span class="keyword">id</span>)p release];</span><br><span class="line"></span><br><span class="line"><span class="comment">// ARCæœ‰æ•ˆ</span></span><br><span class="line"><span class="keyword">id</span> obj = (__bridge_transfer <span class="keyword">id</span>)p;</span><br></pre></td></tr></table></figure><h5 id="Objective-Cå¯¹è±¡å’ŒCore_Foundationå¯¹è±¡ä¹‹é—´çš„ç›¸äº’å˜æ¢">Objective-Cå¯¹è±¡å’ŒCore Foundationå¯¹è±¡ä¹‹é—´çš„ç›¸äº’å˜æ¢</h5><p>å¯ä½¿ç”¨æ–¹æ³•:</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">CFTypeRef</span> <span class="built_in">CFBridgingRetain</span>(<span class="keyword">id</span> X) &#123;</span><br><span class="line">    <span class="keyword">return</span> (__bridge_retained <span class="built_in">CFTypeRef</span>)X;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">id</span> <span class="built_in">CFBridgingRelease</span>(<span class="built_in">CFTypeRef</span> X) &#123;</span><br><span class="line">    <span class="keyword">return</span> (__bridge_transfer <span class="keyword">id</span>)X;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="ARCå®ç°">ARCå®ç°</h4><h5 id="__strongä¿®é¥°ç¬¦">__strongä¿®é¥°ç¬¦</h5><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="keyword">id</span> __<span class="keyword">strong</span> obj = [[<span class="built_in">NSObject</span> alloc] init];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç¼–è¯‘å™¨çš„æ¨¡æ‹Ÿä»£ç </span></span><br><span class="line"><span class="keyword">id</span> obj = objc_msgSend(<span class="built_in">NSObject</span>, <span class="keyword">@selector</span>(alloc));</span><br><span class="line">objc_msgSend(obj, <span class="keyword">@selector</span>(init));</span><br><span class="line">objc_release(obj);</span><br></pre></td></tr></table></figure><p>ç”±æ­¤å¯çŸ¥ï¼ŒARCæœ‰æ•ˆæ—¶ï¼Œç¼–è¯‘å™¨è‡ªåŠ¨æ’å…¥releaseã€‚ä¸‹é¢çœ‹çœ‹éalloc/new/copy/mutableCopyçš„æ–¹æ³•ä¼šæ€æ ·ï¼Ÿ</p><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="keyword">id</span> __<span class="keyword">strong</span> obj = [<span class="built_in">NSArray</span> array];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// ç¼–è¯‘å™¨çš„æ¨¡æ‹Ÿä»£ç </span></span><br><span class="line"><span class="keyword">id</span> obj = objc_msgSend(<span class="built_in">NSArray</span>, <span class="keyword">@selector</span>(array));</span><br><span class="line">objc_retainAutoreleasedReturnValue(obj);</span><br><span class="line">objc_release(obj);</span><br><span class="line"></span><br><span class="line">+ (<span class="keyword">id</span>) array &#123;</span><br><span class="line">    <span class="keyword">return</span> [[<span class="built_in">NSArray</span> alloc] init];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// ç¼–è¯‘å™¨çš„æ¨¡æ‹Ÿä»£ç </span></span><br><span class="line">+ (<span class="keyword">id</span>) array &#123;</span><br><span class="line">    <span class="keyword">id</span> obj = objc_msgSend(<span class="built_in">NSArray</span>, <span class="keyword">@selector</span>(alloc));</span><br><span class="line">    objc_msgSend(obj, <span class="keyword">@selector</span>(init));</span><br><span class="line">    <span class="keyword">return</span> objc_autoreleasedReturnValue(obj);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>objc_autoreleasedReturnValueå’Œobjc_retainAutoreleasedReturnValueè¿™ä¸¤ä¸ªæ˜¯æˆå¯¹çš„ï¼Œä¸»è¦ç”¨äºç¨‹åºä¼˜åŒ–ï¼Œçœå»æ³¨å†Œåˆ°autoreleasePoolçš„è¿‡ç¨‹ã€‚</p><p>objc_autoreleasedReturnValueç”¨äºç±»ä¼¼arrayè¿™ç§ç±»æ–¹æ³•çš„è¿”å›å¯¹è±¡å®ç°ä¸Šã€‚objc_autoreleasedReturnValueä¼šæ£€æŸ¥ä½¿ç”¨è¯¥å‡½æ•°çš„æ–¹æ³•æˆ–å‡½æ•°è°ƒç”¨æ–¹çš„æ‰§è¡Œå‘½ä»¤åˆ—è¡¨ï¼Œå¦‚æœè°ƒç”¨æ–¹è°ƒç”¨äº†æ–¹æ³•æˆ–å‡½æ•°åç´§æ¥ç€è°ƒç”¨objc_retainAutoreleasedReturnValueï¼Œåˆ™ä¸ä¼šå°†è¿”å›çš„å¯¹è±¡æ³¨å†Œåˆ°autoreleasePoolï¼Œè€Œæ˜¯ç›´æ¥ä¼ åˆ°æ–¹æ³•æˆ–å‡½æ•°çš„è°ƒç”¨æ–¹ã€‚æ²¡æœ‰ç´§æ¥è¯¥å‡½æ•°ï¼Œåˆ™æ³¨å†Œåˆ°autoreleasePoolã€‚</p><p><img src="/images/è‡ªåŠ¨å¼•ç”¨è®¡æ•°/15806374729341.jpg" alt></p><h5 id="__weakä¿®é¥°ç¬¦">__weakä¿®é¥°ç¬¦</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    // å‡è®¾objæ˜¯__strongä¿®é¥°ä¸”èµ‹è¿‡å€¼</span><br><span class="line">    id __weak objc1 = obj;</span><br><span class="line">    </span><br><span class="line">    // ç¼–è¯‘å™¨æ¨¡æ‹Ÿä»£ç </span><br><span class="line">    id obj1;</span><br><span class="line">    objc_initWeak(&amp;obj1, obj);</span><br><span class="line">    objc_destroyWeak(&amp;obj1);</span><br><span class="line">    </span><br><span class="line">    // objc_initWeakæ–¹æ³•å®é™…å¦‚ä¸‹ï¼š</span><br><span class="line">    // å…ˆå°†obj1èµ‹0ï¼Œå†é€šè¿‡storeWeakæ–¹æ³•èµ‹å€¼</span><br><span class="line">    obj1 = 0;</span><br><span class="line">    objc_storeWeak(&amp;obj1, obj);</span><br><span class="line">    </span><br><span class="line">    // objc_destroyWeakæ–¹æ³•å®é™…å¦‚ä¸‹ï¼š</span><br><span class="line">    objc_storeWeak(&amp;obj1, 0);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>objc_storeWeakå‡½æ•°æŠŠç¬¬äºŒå‚æ•°çš„èµ‹å€¼å¯¹è±¡çš„åœ°å€ä½œä¸ºé”®å€¼ï¼Œå°†ç¬¬ä¸€å‚æ•°çš„é™„æœ‰<strong>weakä¿®é¥°ç¬¦çš„å˜é‡çš„åœ°å€æ³¨å†Œåˆ°weakè¡¨ä¸­ã€‚å¦‚æœç¬¬äºŒå‚æ•°ä¸º0ï¼Œåˆ™æŠŠå˜é‡çš„åœ°å€ä»weakè¡¨ä¸­åˆ é™¤ã€‚<br>weakè¡¨ä¸å¼•ç”¨è®¡æ•°è¡¨ç›¸åŒï¼Œä½œä¸ºæ•£åˆ—è¡¨è¢«å®ç°ã€‚å¦‚æœä½¿ç”¨weakè¡¨ï¼Œå°†åºŸå¼ƒå¯¹è±¡çš„åœ°å€ä½œä¸ºé”®å€¼æ£€ç´¢ï¼Œå°±èƒ½é«˜é€Ÿåœ°è·å–å¯¹åº”çš„é™„æœ‰</strong>weakä¿®é¥°ç¬¦çš„å˜é‡çš„åœ°å€ã€‚å¦å¤–ï¼Œç”±äºä¸€ä¸ªå¯¹è±¡å¯åŒæ—¶èµ‹å€¼ç»™å¤šä¸ªé™„æœ‰__weakä¿®é¥°ç¬¦çš„å˜é‡ä¸­ï¼Œæ‰€ä»¥å¯¹äºä¸€ä¸ªé”®å€¼ï¼Œå¯æ³¨å†Œå¤šä¸ªå˜é‡çš„åœ°å€ã€‚</p><p>åºŸå¼ƒè°éƒ½ä¸æŒæœ‰çš„å¯¹è±¡ï¼Œå…·ä½“æ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿå¯¹è±¡é€šè¿‡objc_releaseå‡½æ•°é‡Šæ”¾è¿‡ç¨‹</p><ol><li>objc_release</li><li>å¼•ç”¨è®¡æ•°ä¸º0ï¼Œè°ƒç”¨dealloc</li><li>_objc_rootDealloc</li><li>object_dispose</li><li>objc_destructInstance</li><li>objc_clear_deallocating</li></ol><p>objc_clear_deallocatingå‡½æ•°çš„å…·ä½“åŠ¨ä½œå¦‚ä¸‹ï¼š</p><ol><li>ä»weakè¡¨ä¸­è·å–åºŸå¼ƒå¯¹è±¡çš„åœ°å€ä¸ºé”®å€¼çš„è®°å½•</li><li>å°†åŒ…å«åœ¨è®°å½•ä¸­çš„æ‰€æœ‰é™„æœ‰__weakä¿®é¥°ç¬¦å˜é‡çš„åœ°å€ï¼Œèµ‹å€¼ä¸ºnil</li><li>ä»weakè¡¨ä¸­åˆ é™¤è¯¥è®°å½•</li><li>ä»å¼•ç”¨è®¡æ•°è¡¨ä¸­åˆ é™¤åºŸå¼ƒå¯¹è±¡çš„åœ°å€ä¸ºé”®å€¼çš„è®°å½•</li></ol><p>ä»¥ä¸Šæ­¥éª¤è¯´æ˜äº†<strong>weakä¿®é¥°ç¬¦çš„å˜é‡æ‰€å¼•ç”¨çš„å¯¹è±¡è¢«åºŸå¼ƒï¼Œåˆ™å°†nilèµ‹å€¼ç»™è¯¥å˜é‡è¿™ä¸€åŠŸèƒ½çš„å®ç°ã€‚å¤§é‡ä½¿ç”¨</strong>weakï¼Œä¼šæ¶ˆè€—CPUèµ„æºã€‚</p><h5 id="autoreleaseing">autoreleaseing</h5><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">@autoreleasepool</span> &#123;</span><br><span class="line">    <span class="keyword">id</span> __autoreleasing obj = [[<span class="built_in">NSObject</span> alloc] init];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç¼–è¯‘å™¨æ¨¡æ‹Ÿä»£ç </span></span><br><span class="line"><span class="keyword">id</span> pool = objc_autoreleasePoolPush();</span><br><span class="line"><span class="keyword">id</span> obj = objc_msgSend(<span class="built_in">NSObject</span>, <span class="keyword">@selector</span>(alloc));</span><br><span class="line">objc_msgSend(objc, <span class="keyword">@selector</span>(init));</span><br><span class="line">objc_autorelease(obj);</span><br><span class="line">objc_autoreleasePoolPop(pool);</span><br></pre></td></tr></table></figure><h5 id="å¼•ç”¨è®¡æ•°-1">å¼•ç”¨è®¡æ•°</h5><p>_objc_rootRetainCount(id obj) ç»Ÿè®¡å¼•ç”¨è®¡æ•°</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;å‰è¨€ï¼Œä¹…ä»°ã€ŠObjective-Cé«˜çº§ç¼–ç¨‹ iOSä¸OS Xå¤šçº¿ç¨‹å’Œå†…å­˜ç®¡ç†ã€‹è¿™æœ¬ä¹¦å¤§åï¼Œè¶ç€æ”¾å‡å­¦ä¹ ä¸€ä¸‹ã€‚ä¸»è¦å†…å®¹æœ‰ä¸‰å—ï¼šè‡ªåŠ¨å¼•ç”¨è®¡æ•°ã€Blocksã€GCDã€‚å†…å®¹ä¸å¤šï¼Œä½†æ˜¯è®²å¾—æ¯”è¾ƒæ·±å…¥ï¼Œä¸”æ˜¯iOSåŸºç¡€çŸ¥è¯†ï¼Œå€¼å¾—è¯¦ç»†é˜…è¯»ã€‚æœ¬æ–‡ä¸ºè‡ªåŠ¨å¼•ç”¨éƒ¨åˆ†çš„ä¸€äº›ç¬”è®°ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="iOS" scheme="https://github.com/zhuangxq/zhuangxq.github.io.git/tags/iOS/"/>
    
  </entry>
  
  <entry>
    <title>å·æ»‡è—ç¿»å±±è¶Šå²­ä¹‹æ—…</title>
    <link href="https://github.com/zhuangxq/zhuangxq.github.io.git/2019/10/27/%E5%B7%9D%E6%BB%87%E8%97%8F%E7%BF%BB%E5%B1%B1%E8%B6%8A%E5%B2%AD%E4%B9%8B%E6%97%85/"/>
    <id>https://github.com/zhuangxq/zhuangxq.github.io.git/2019/10/27/å·æ»‡è—ç¿»å±±è¶Šå²­ä¹‹æ—…/</id>
    <published>2019-10-27T09:10:40.000Z</published>
    <updated>2020-02-03T09:37:34.534Z</updated>
    
    <content type="html"><![CDATA[<p>æœ€è¿‘å‡ å¹´ï¼Œæ¯å¹´å›½åº†éƒ½å‡ºå»ç©ï¼Œå»äº†å‡ ä¸ªåœ°æ–¹éƒ½æ²¡æœ‰ä»€ä¹ˆè®°å½•ã€‚ä»Šå¹´çªç„¶æƒ³è®°å½•ä¸‹ï¼Œäºæ˜¯æƒ³èµ·äº†å‡ å¹´å‰æ­çš„blogï¼Œæ²¡å†™ä»€ä¹ˆä¸œè¥¿ï¼Œè‰å€’æ˜¯é•¿æ»¡äº†ã€‚é¡ºä¾¿ï¼Œä¹Ÿç»™blogå¦å¦è’ã€‚</p><p>å¯¹äºä»å°ç”Ÿæ´»åœ¨å—æ–¹ï¼Œå±±ä¿Šæ°´ç§€åˆé æµ·ï¼Œç„¶è€Œéƒ½æ˜¯ä¸˜é™µï¼Œæ€»æ˜¾å¾—æœ‰ç‚¹â€œå°æ°”â€ï¼Œæ‰“å¿ƒåº•æ˜¯æœ‰ç‚¹å‘å¾€è¥¿åŒ—çš„å¹¿è¢¤å£®é˜”ã€‚æ‰€ä»¥ä¹‹å‰å»äº†é’æµ·ã€æ–°ç–†ï¼Œä»Šå¹´å›½åº†åˆèµ°äº†å››å·ã€äº‘å—ã€è¥¿è—ã€‚æ¼«æ¼«é•¿è·¯ï¼Œç¿»å±±è¶Šå²­ï¼Œè®©æˆ‘ä»¬å‡ºå‘å’¯ã€‚</p><h3 id="å‡ºå‘å‡†å¤‡">å‡ºå‘å‡†å¤‡</h3><p>å¤§æ¦‚å…«æœˆè·Ÿå°ä¼™ä¼´å®šä¸‹æ¥è¦èµ°å·è—çº¿ï¼Œæˆéƒ½åˆ°æ‹‰è¨ï¼Œäºæ˜¯ä¸€ä¸ªå¤šæœˆï¼Œé™†é™†ç»­ç»­åšå‡†å¤‡ã€‚å»å¹´æˆ‘ä»¬åœ¨æ–°ç–†ï¼Œè‡ªé©¾äº†è¿‘ä¸‰åƒå…¬é‡Œï¼Œç¯åŒ—ç–†ä¸€å¤§åœˆï¼Œç¿»è¿‡ç‹¬åº“å…¬è·¯ã€‚æ‰€ä»¥è¿™æ¬¡æ¯«æ— ç–‘é—®ï¼Œä¹Ÿæ˜¯ç»§ç»­è‡ªé©¾ã€‚è‡ªé©¾çš„å¥½å¤„æ— éœ€å¤šè¨€ï¼Œè‡ªç”±ï¼Œæ²¡æœ‰è¡Œç¨‹çº¦æŸï¼Œç”šè‡³å¯ä»¥èµ°å“ªç®—å“ªï¼Œå½“ç„¶ä¹Ÿå¯ä»¥ä½“éªŒä¸‹é©¾é©¶çš„ä¹è¶£ğŸ˜†ã€‚ç§Ÿè½¦å¯¹æ¯”å¤šå®¶ï¼Œæœ€ç»ˆåœ¨æ·˜å®è®¢äº†ä¸€è¾†ä¸°ç”°æ™®æ‹‰å¤šï¼Œ2.7Læ’é‡ï¼Œ10å¤©13000äººæ°‘å¸ã€‚ä¸»è¦æ˜¯å¼‚åœ°è¿˜è½¦è´¹è´µï¼Œæˆéƒ½å€Ÿæ‹‰è¨è¿˜ç‰¹åˆ«è´µã€‚æ¯•ç«Ÿå¤§å®¶éƒ½æ˜¯è¿›è—çš„è·¯çº¿ã€‚è·¯çº¿æˆ‘ä»¬è®¢äº†ä¸ªå¤§æ¦‚è¡Œç¨‹ï¼Œæˆéƒ½-&gt;ç¨»åŸ-&gt;å¾·é’¦(æ¢…é‡Œé›ªå±±)-&gt;G214-&gt;G318-&gt;æ‹‰è¨ï¼Œç”±äºæ²¡ç¡®å®šåœ¨ç¨»åŸè¦èŠ±å¤šå°‘æ—¶é—´ï¼Œæ‰€ä»¥ç¨»åŸåé¢æ¯å¤©åˆ°å“ªå…·ä½“è¡Œç¨‹éƒ½æ²¡å®šï¼Œåæ­£èµ°åˆ°å“ªç®—å“ªéƒ½æ²¡é—®é¢˜ã€‚</p><p>å…³äºè¿›é«˜åŸçš„ä¸€äº›æ³¨æ„äº‹é¡¹ï¼Œé«˜åŸç¼ºæ°§</p><p>æœªå®Œå¾…ç»­<del>~</del>~</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æœ€è¿‘å‡ å¹´ï¼Œæ¯å¹´å›½åº†éƒ½å‡ºå»ç©ï¼Œå»äº†å‡ ä¸ªåœ°æ–¹éƒ½æ²¡æœ‰ä»€ä¹ˆè®°å½•ã€‚ä»Šå¹´çªç„¶æƒ³è®°å½•ä¸‹ï¼Œäºæ˜¯æƒ³èµ·äº†å‡ å¹´å‰æ­çš„blogï¼Œæ²¡å†™ä»€ä¹ˆä¸œè¥¿ï¼Œè‰å€’æ˜¯é•¿æ»¡äº†ã€‚é¡ºä¾¿ï¼Œä¹Ÿç»™blogå¦å¦è’ã€‚&lt;/p&gt;
&lt;p&gt;å¯¹äºä»å°ç”Ÿæ´»åœ¨å—æ–¹ï¼Œå±±ä¿Šæ°´ç§€åˆé æµ·ï¼Œç„¶è€Œéƒ½æ˜¯ä¸˜é™µï¼Œæ€»æ˜¾å¾—æœ‰ç‚¹â€œå°æ°”â€ï¼Œæ‰“å¿ƒåº•æ˜¯æœ‰ç‚¹å‘å¾€è¥¿åŒ—çš„å¹¿è¢¤å£®é˜”
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>AFNetworkingæºç é˜…è¯»ç¬”è®°ä¹‹äºŒ--AFURLRequestSerialization/AFURLResponseSerialization</title>
    <link href="https://github.com/zhuangxq/zhuangxq.github.io.git/2016/07/02/AFNetworking%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E4%B9%8B%E4%BA%8C-AFURLRequestSerialization-AFURLResponseSerialization/"/>
    <id>https://github.com/zhuangxq/zhuangxq.github.io.git/2016/07/02/AFNetworkingæºç é˜…è¯»ä¹‹äºŒ-AFURLRequestSerialization-AFURLResponseSerialization/</id>
    <published>2016-07-02T07:56:23.000Z</published>
    <updated>2019-10-27T08:25:05.492Z</updated>
    
    <content type="html"><![CDATA[<p>ç»§ç»­AFNetworkingç¬”è®°ã€‚æœ¬ç¯‡ä¸»è¦å…³äºNSURLRequestçš„ç”Ÿæˆï¼Œè¯·æ±‚å›æ¥å“åº”çš„å¤„ç†ã€‚</p><a id="more"></a><h2 id="AFHTTPRequestSerializer">AFHTTPRequestSerializer</h2><p>AFHTTPRequestSerializeræ˜¯ç”ŸæˆNSURLRequestæ ¸å¿ƒç±»ã€‚å®ƒæœ‰ä¸¤ä¸ªå­ç±»AFJSONRequestSerializerã€AFPropertyListRequestSerializerï¼Œåˆ†åˆ«å¯¹åº”ä¸åŒçš„å‚æ•°ç”Ÿæˆæ–¹å¼ã€‚ç”Ÿæˆrequestæ–¹æ³•ï¼š</p><pre><code>- (<span class="type">NSMutableURLRequest</span> *)requestWithMethod:(<span class="type">NSString</span> *)<span class="keyword">method</span>                                 <span class="type">URLString</span>:(<span class="type">NSString</span> *)<span class="type">URLString</span>                                parameters:(id)parameters                                     error:(<span class="type">NSError</span> *__autoreleasing *)error{    <span class="type">NSParameterAssert</span>(<span class="keyword">method</span>);    <span class="type">NSParameterAssert</span>(<span class="type">URLString</span>);    <span class="type">NSURL</span> *url = [<span class="type">NSURL</span> <span class="type">URLWithString</span>:<span class="type">URLString</span>];    <span class="type">NSParameterAssert</span>(url);    <span class="type">NSMutableURLRequest</span> *mutableRequest = [[<span class="type">NSMutableURLRequest</span> alloc] initWithURL:url];    mutableRequest.<span class="type">HTTPMethod</span> = <span class="keyword">method</span>;    <span class="keyword">for</span> (<span class="type">NSString</span> *keyPath <span class="keyword">in</span> <span class="type">AFHTTPRequestSerializerObservedKeyPaths</span>()) { <span class="comment">#1</span>        <span class="keyword">if</span> ([self.mutableObservedChangedKeyPaths containsObject:keyPath]) {  <span class="comment">#1</span>            [mutableRequest setValue:[self valueForKeyPath:keyPath] forKey:keyPath]; <span class="comment">#1</span>        }    }    mutableRequest = [[self requestBySerializingRequest:mutableRequest withParameters:parameters error:error] mutableCopy];  <span class="comment">#2</span>    <span class="keyword">return</span> mutableRequest;}</code></pre><p>è¯¥æ–¹æ³•åˆ›å»ºä¸€ä¸ªæ–°NSMutableRequestï¼Œ#1éƒ¨åˆ†æ˜¯åœ¨è®¾ç½®ä¸€äº›è¯·æ±‚é…ç½®ï¼Œå¦‚allowsCellularAccessã€cachePolicyã€HTTPShouldHandleCookiesç­‰ã€‚è¿™äº›é…ç½®çš„è®¾ç½®é€šè¿‡KVOè§‚å¯Ÿï¼Œæœ‰è®¾ç½®å€¼ï¼Œåˆ™å­˜åˆ°self.mutableObservedChangedKeyPathsï¼Œå†æŠŠè¿™äº›å€¼é€šè¿‡KVCè®¾ç½®åˆ°NSMutableRequestã€‚è¿™ä¸ªæ–¹å¼å€¼å¾—å€Ÿé‰´ï¼Œç®€ä¾¿æ˜äº†ã€‚#2éƒ¨åˆ†åˆ™æ˜¯è°ƒç”¨è®¾ç½®è¯·æ±‚å‚æ•°çš„æ–¹æ³•ï¼Œè¿™æ˜¯ä¸ªAFURLRequestSerializationåè®®æ–¹æ³•ã€‚æ¥ä¸‹æ¥çœ‹ä¸‹AFHTTPRequestSerializerå¯¹è¿™ä¸ªæ–¹æ³•çš„å®ç°ï¼ˆä¸‹é¢æ‰€æœ‰ä»£ç éƒ½ä¼šæœ‰ç•¥å»ä¸€äº›éå…³é”®ä»£ç ï¼‰ï¼š</p><pre><code>- (<span class="built_in">NSURLRequest</span> *)requestBySerializingRequest:(<span class="built_in">NSURLRequest</span> *)request                               withParameters:(<span class="keyword">id</span>)parameters                                        error:(<span class="built_in">NSError</span> *__autoreleasing *)error{    <span class="built_in">NSMutableURLRequest</span> *mutableRequest = [request mutableCopy];    <span class="built_in">NSString</span> *query = <span class="literal">nil</span>;    <span class="keyword">if</span> (parameters) {        <span class="keyword">if</span> (<span class="keyword">self</span><span class="variable">.queryStringSerialization</span>) {  <span class="comment">//ä¸€ä¸ªblockï¼Œå‚æ•°ç”Ÿæˆçš„æ–¹æ³•å¤–åŒ…å‡ºå»äº†ï¼Œç»™å¤–éƒ¨è‡ªè¡Œå®ç°ã€‚</span>            <span class="built_in">NSError</span> *serializationError;            query = <span class="keyword">self</span><span class="variable">.queryStringSerialization</span>(request, parameters, &amp;serializationError);            <span class="keyword">if</span> (serializationError) {                <span class="keyword">if</span> (error) {                    *error = serializationError;                }                <span class="keyword">return</span> <span class="literal">nil</span>;            }        } <span class="keyword">else</span> {            <span class="keyword">switch</span> (<span class="keyword">self</span><span class="variable">.queryStringSerializationStyle</span>) {                <span class="keyword">case</span> AFHTTPRequestQueryStringDefaultStyle: <span class="comment">//é»˜è®¤å‚æ•°ç”Ÿæˆæ–¹æ³•,ç±»ä¼¼è¿™æ ·ï¼šver=1.3.0&amp;idfa=<span class="doctag"><span class="keyword">xxx</span></span></span>                    query = AFQueryStringFromParameters(parameters);                    <span class="keyword">break</span>;            }        }    }    <span class="keyword">if</span> ([<span class="keyword">self</span><span class="variable">.HTTPMethodsEncodingParametersInURI</span> containsObject:[[request HTTPMethod] uppercaseString]]) {    <span class="comment">//å¦‚æœè¯·æ±‚æ–¹å¼æ˜¯ GET,HEAD,DELETE, åˆ™å°†å‚æ•°æ¥åˆ°URLåé¢</span>        <span class="keyword">if</span> (query &amp;&amp; query<span class="variable">.length</span> &gt; <span class="number">0</span>) {            mutableRequest<span class="variable">.URL</span> = [<span class="built_in">NSURL</span> URLWithString:[[mutableRequest<span class="variable">.URL</span> absoluteString] stringByAppendingFormat:mutableRequest<span class="variable">.URL</span><span class="variable">.query</span> ? <span class="string">@"&amp;%@"</span> : <span class="string">@"?%@"</span>, query]];        }    } <span class="keyword">else</span> {    <span class="comment">//POSTæ–¹æ³•</span>        <span class="comment">// #2864: an empty string is a valid x-www-form-urlencoded payload</span>        <span class="keyword">if</span> (!query) {            query = <span class="string">@""</span>;        }        <span class="keyword">if</span> (![mutableRequest valueForHTTPHeaderField:<span class="string">@"Content-Type"</span>]) {            [mutableRequest setValue:<span class="string">@"application/x-www-form-urlencoded"</span> forHTTPHeaderField:<span class="string">@"Content-Type"</span>];        }        [mutableRequest setHTTPBody:[query dataUsingEncoding:<span class="keyword">self</span><span class="variable">.stringEncoding</span>]];<span class="comment">//è®¾ç½®HTTPBody</span>    }    <span class="keyword">return</span> mutableRequest;}</code></pre><p>ç”ŸæˆNSURLRequestå¤§è‡´å¦‚æ­¤ï¼ŒAFJSONRequestSerializerå¯¹åº”çš„å‚æ•°ç”Ÿæˆæ–¹æ³•ï¼š[NSJSONSerialization dataWithJSONObject:parameters options:self.writingOptions error:error]ï¼Œ AFPropertyListRequestSerializerå¯¹åº”çš„å‚æ•°ç”Ÿæˆæ–¹æ³•ï¼š[NSPropertyListSerialization dataWithPropertyList:parameters format:self.format options:self.writeOptions error:error]ã€‚ å¦‚æœå‚æ•°æœ‰è‡ªå·±æ¯”è¾ƒç‰¹æ®Šç»“æ„ï¼Œå¯ä»¥ä»¿AFJSONRequestSerializerï¼Œå®ç°åè®®æ–¹æ³•ï¼Œè‡ªå®šä¹‰ç”Ÿæˆæ–¹å¼ã€‚</p><h3 id="åˆ†å—æ•°æ®ä¸Šä¼ ">åˆ†å—æ•°æ®ä¸Šä¼ </h3><p>AFHTTPRequestSerializerè¿™ä¸ªç±»è¿˜æœ‰ä¸ªæ¯”è¾ƒé‡è¦çš„åŠŸèƒ½ï¼Œå°±æ˜¯å®ç°åˆ†å—æ•°æ®ä¸Šä¼ çš„åŠŸèƒ½ã€‚åˆ†å—ä¸Šä¼ æ˜¯ä»€ä¹ˆä¸œè¥¿ï¼Ÿæˆ‘ä»¬çŸ¥é“HTTPåˆ†ä¸ºä¸‰éƒ¨åˆ†ï¼šçŠ¶æ€è¡Œï¼Œè¯·æ±‚å¤´ï¼Œè¯·æ±‚ä½“ã€‚ä¸»è¦æ•°æ®ä¸€èˆ¬æ”¾è¯·æ±‚ä½“ï¼Œè¯·æ±‚ä½“å´åªæœ‰ä¸€ä¸ªã€‚é‚£å¦‚ä½•å®ç°å¤šå—æ•°æ®ä¸Šä¼ ï¼Ÿç­”æ¡ˆå¾ˆç®€å•ï¼Œå°±æ˜¯å¤šå—æ•°æ®æŒ‰ç…§ä¸€å®šæ ¼å¼æ‹¼æˆä¸€å—ï¼Œå¹¶ä¸”å¤šå—æ•°æ®é—´æœ‰åˆ†éš”ç¬¦ï¼Œè¯·æ±‚æ–¹éœ€è¦å‘Šè¯‰å“åº”æ–¹å½“å‰è¯·æ±‚æ˜¯ä¸ªåˆ†å—æ•°æ®å’Œåˆ†å‰²ç¬¦é•¿å•¥æ ·ã€‚å…ˆçœ‹ä¸‹å¦‚ä½•ç”¨è¿™ä¸ªåŠŸèƒ½ã€‚</p><pre><code>AFHTTPSessionManager *session = [AFHTTPSessionManager manager];[session <span class="string">POST:</span>@<span class="string">"https://api.app.net/stream/0/posts/stream/global"</span> <span class="string">parameters:</span>nil <span class="string">constructingBodyWithBlock:</span>^(id&lt;AFMultipartFormData&gt;  _Nonnull formData) {    NSData *data1 = [@<span class="string">"æˆ‘æ˜¯multipart data part111"</span> <span class="string">dataUsingEncoding:</span>NSUTF8StringEncoding];    NSData *data2 = [@<span class="string">"æˆ‘æ˜¯multipart data part222"</span> <span class="string">dataUsingEncoding:</span>NSUTF8StringEncoding];    NSData *data3 = [@<span class="string">"æˆ‘æ˜¯multipart data part333"</span> <span class="string">dataUsingEncoding:</span>NSUTF8StringEncoding];    [formData <span class="string">appendPartWithFormData:</span>data1 <span class="string">name:</span>@<span class="string">"11111"</span>];    [formData <span class="string">appendPartWithFormData:</span>data2 <span class="string">name:</span>@<span class="string">"22222"</span>];    [formData <span class="string">appendPartWithFormData:</span>data3 <span class="string">name:</span>@<span class="string">"33333"</span>];} <span class="string">progress:</span>^(NSProgress * _Nonnull uploadProgress) {} <span class="string">success:</span>^(NSURLSessionDataTask * _Nonnull task, id  _Nullable responseObject) {    NSLog(@<span class="string">"success:%@"</span>, responseObject);} <span class="string">failure:</span>^(NSURLSessionDataTask * _Nullable task, NSError * _Nonnull error) {    NSLog(@<span class="string">"failed:%@"</span>, error);}];</code></pre><p>è¿™ä¸ªä¸æ­£å¸¸çš„è¯·æ±‚ç›¸æ¯”å¤šäº†constructingBodyWithBlockï¼Œè¿™ä¸ªblockå°±æ˜¯ç”¨æ¥æ·»åŠ åˆ†å—æ•°æ®ã€‚å†çœ‹çœ‹è¿™ä¸ªè¯·æ±‚ï¼Œæœ€ç»ˆçš„HTTPè¯·æ±‚é•¿ä»€ä¹ˆæ ·ã€‚</p><p><img src="/images/af_multipart_2.png" alt><br><img src="/images/af_multipart_3.png" alt></p><p>çœ‹è¯·æ±‚å¤´çš„Content-Type:multipart/form-data; boundary=Boundary+7C0ABF26A3C30CEBã€‚è¿™æ˜¯åˆ†å—ä¸Šä¼ å¿…é¡»æœ‰çš„ä¸€ä¸ªheaderï¼Œå‘Šè¯‰å“åº”æ–¹å½“å‰æ˜¯åˆ†å—æ•°æ®ï¼Œä¸”åˆ†å‰²çº¿ä¸ºBoundary+7C0ABF26A3C30CEBï¼Œå“åº”æ–¹æ®æ­¤å¤„ç†ã€‚ç”±äºåˆ†å‰²çº¿è‚¯å®šä¸èƒ½è·Ÿæ•°æ®å—æœ‰ä¸€æ ·çš„æƒ…å†µï¼Œæ‰€ä»¥åˆ†å‰²çº¿ä¸€èˆ¬æ˜¯ä¸€ä¸ªéšæœºå¤æ‚è¾ƒé•¿çš„å€¼ã€‚æ¥ç€çœ‹è¯·æ±‚ä½“ï¼Œå»æ‰åˆ†å‰²çº¿ï¼Œå°±å‰©ä¸‹ä¸‰æ®µæ•°æ®ï¼Œæ¯æ®µæ•°æ®ç”±Content-Dispositionã€ç©ºè¡Œã€æ•°æ®ç»„æˆï¼Œ<a href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec19.html" target="_blank" rel="noopener">Content-Disposition</a>å®˜æ–¹é‡Šä¹‰ï¼šThe Content-Disposition response-header field has been proposed as a means for the origin server to suggest a default filename if the user requests that the content is saved to a file. å°±æ˜¯å¦‚æœè¿™å—æ•°æ®æ˜¯è¦è¢«ä¿å­˜æˆæ–‡ä»¶ï¼Œé‚£ä¹ˆContent-Dispositionè¿™ä¸ªheaderå°±å¯ä»¥æä¾›é»˜è®¤åã€‚å¯ä»¥çŸ¥é“ï¼Œå…¶å®åˆ†å—æ•°æ®è¯·æ±‚å…¶å®å°±æ˜¯POSTè¯·æ±‚ï¼Œåªä¸è¿‡åœ¨è¯·æ±‚ä½“æ•°æ®åšæ–‡ç« è€Œå·²ã€‚ä¸‹é¢çš„å†…å®¹ï¼Œéƒ½æ˜¯å›´ç»•å¦‚ä½•ç”Ÿæˆè¿™ä¸ªæœ€ç»ˆçš„è¯·æ±‚ä½“æ•°æ®åœ¨åšæ–‡ç« ã€‚</p><p>çœ‹ç›¸å…³çš„å‡ ä¸ªç±»ï¼š</p><p><img src="/images/afnet_multipart.png" alt></p><p>AFStreamingMultipartæ€»ç®¡åˆ†å—æ•°æ®çš„ç”Ÿæˆæ¨¡å—ï¼ŒAFMultipartBodyStreamæ˜¯ä¸€ä¸ªæ•°æ®æµï¼ŒAFHTTPBodyPartæ˜¯å…·ä½“çš„æ¯ä¸ªæ•°æ®å—çš„å†…å®¹ã€‚AFMultipartFormDataæä¾›å„ç§å„æ ·æ•°æ®(string,data,file,streamâ€¦)çš„æ·»åŠ æ¥å£ã€‚ä¸‹é¢çœ‹muiltipartè¯·æ±‚å¦‚ä½•ç”Ÿæˆ(çœç•¥éå…³é”®ä»£ç ):</p><pre><code>- (<span class="type">NSMutableURLRequest</span> *)multipartFormRequestWithMethod:(<span class="type">NSString</span> *)<span class="keyword">method</span>                                              <span class="type">URLString</span>:(<span class="type">NSString</span> *)<span class="type">URLString</span>                                             parameters:(<span class="type">NSDictionary</span> *)parameters                              constructingBodyWithBlock:(<span class="type">void</span> (^)(id &lt;<span class="type">AFMultipartFormData</span>&gt; formData))<span class="keyword">block</span>                                                  error:(<span class="type">NSError</span> *__autoreleasing *)error{    <span class="type">NSMutableURLRequest</span> *mutableRequest = [self requestWithMethod:<span class="keyword">method</span> <span class="type">URLString</span>:<span class="type">URLString</span> parameters:<span class="keyword">nil</span> error:error];    __block <span class="type">AFStreamingMultipartFormData</span> *formData = [[<span class="type">AFStreamingMultipartFormData</span> alloc] initWithURLRequest:mutableRequest stringEncoding:<span class="type">NSUTF8StringEncoding</span>];    <span class="keyword">if</span> (parameters) {        ...parametersè½¬æˆdataå½“æˆä¸€ä¸ªæ•°æ®å—æ·»åŠ åˆ°formData...        [formData appendPartWithFormData:data name:[pair.field description]];    }    //æ·»åŠ æ•°æ®å—    <span class="keyword">if</span> (<span class="keyword">block</span>) {        <span class="keyword">block</span>(formData);    }    //å°†å·²æ·»åŠ çš„æ•°æ®å—æ‹¼è£…æˆæœ€ç»ˆå½¢å¼ï¼Œè¿”å›ã€‚    <span class="keyword">return</span> [formData requestByFinalizingMultipartFormData];}</code></pre><p>æ•°æ®å—å¦‚ä½•æ·»åŠ ï¼Œä¸¾ä¸ªæ–‡ä»¶å¦‚ä½•æ·»åŠ çš„ä¾‹å­ï¼š</p><pre><code>- (<span class="built_in">BOOL</span>)appendPartWithFileURL:(<span class="built_in">NSURL</span> *)fileURL                         name:(<span class="built_in">NSString</span> *)name                     fileName:(<span class="built_in">NSString</span> *)fileName                     mimeType:(<span class="built_in">NSString</span> *)mimeType                        error:(<span class="built_in">NSError</span> * __autoreleasing *)error{    ...åˆ¤æ–­å‚æ•°æ˜¯å¦æ­£ç¡®ï¼Œfileæ˜¯å¦å­˜åœ¨...    <span class="built_in">NSDictionary</span> *fileAttributes = [[<span class="built_in">NSFileManager</span> defaultManager] attributesOfItemAtPath:[fileURL path] error:error];    <span class="keyword">if</span> (!fileAttributes) {        <span class="keyword">return</span> <span class="literal">NO</span>;    }    <span class="comment">//è®¾ç½®è¿™ä¸ªæ•°æ®å—çš„headerï¼ŒContent-Dispositonå’ŒContent-Typeã€‚Content-TypeæŒ‡çš„æ˜¯è¿™å—æ•°æ®çš„ç±»å‹ã€‚</span>    <span class="built_in">NSMutableDictionary</span> *mutableHeaders = [<span class="built_in">NSMutableDictionary</span> dictionary];    [mutableHeaders setValue:[<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"form-data; name=\"%@\"; filename=\"%@\""</span>, name, fileName] forKey:<span class="string">@"Content-Disposition"</span>];    [mutableHeaders setValue:mimeType forKey:<span class="string">@"Content-Type"</span>];    <span class="comment">//æè¿°è¿™ä¸ªæ•°æ®å—çš„ç±»ï¼Œæœ‰header,boundary,stringEncoding,lengthç­‰åŸºæœ¬ä¿¡æ¯ï¼Œbodyå°±æ˜¯å­˜æ•°æ®çš„å†…å®¹ï¼Œç±»å‹ä¸ºidï¼Œå¯ä»¥æ”¾å„ç§å„æ ·æ•°æ®ï¼Œè¿™é‡Œæ”¾æ–‡ä»¶URLã€‚æœ€ç»ˆä¼šé€šè¿‡æµè¯»å‡ºæ•°æ®ã€‚</span>    AFHTTPBodyPart *bodyPart = [[AFHTTPBodyPart alloc] init];    bodyPart<span class="variable">.stringEncoding</span> = <span class="keyword">self</span><span class="variable">.stringEncoding</span>;    bodyPart<span class="variable">.headers</span> = mutableHeaders;    bodyPart<span class="variable">.boundary</span> = <span class="keyword">self</span><span class="variable">.boundary</span>;    bodyPart<span class="variable">.body</span> = fileURL;    bodyPart<span class="variable">.bodyContentLength</span> = [fileAttributes[<span class="built_in">NSFileSize</span>] unsignedLongLongValue];    <span class="comment">//å•ä¸ªæ•°æ®å—æ·»åŠ åˆ°æ•´ä¸ªæ•°æ®å—ä¸­</span>    [<span class="keyword">self</span><span class="variable">.bodyStream</span> appendHTTPBodyPart:bodyPart];    <span class="keyword">return</span> <span class="literal">YES</span>;}</code></pre><p>å…¶ä»–æ•°æ®ç±»å‹æ·»åŠ å¤§åŒå°å¼‚ï¼Œä¸å†èµ˜è¿°ã€‚</p><p>æ•°æ®å—æ·»åŠ å®Œï¼Œå†çœ‹å„ä¸ªæ•°æ®å—å¦‚ä½•æ‹¼è£…æˆæœ€åçš„è¯·æ±‚ä½“ã€‚</p><pre><code>- (NSMutableURLRequest *)requestByFinalizingMultipartFormData {    // Reset the initial and final boundaries <span class="keyword">to</span> ensure correct Content-Length    [<span class="literal">self</span>.bodyStream <span class="built_in">set</span>InitialAndFinalBoundaries];    [<span class="literal">self</span>.request <span class="built_in">set</span>HTTPBodyStream:<span class="literal">self</span>.bodyStream];    [<span class="literal">self</span>.request <span class="built_in">set</span>Value:[NSString stringWithFormat:@<span class="string">"multipart/form-data; boundary=%@"</span>, <span class="literal">self</span>.boundary] <span class="keyword">for</span>HTTPHeaderField:@<span class="string">"Content-Type"</span>];    [<span class="literal">self</span>.request <span class="built_in">set</span>Value:[NSString stringWithFormat:@<span class="string">"%llu"</span>, [<span class="literal">self</span>.bodyStream contentLength]] <span class="keyword">for</span>HTTPHeaderField:@<span class="string">"Content-Length"</span>];    return <span class="literal">self</span>.request;}</code></pre><p>è¿™é‡Œä¸»è¦å…³å¿ƒ[self.request setHTTPBodyStream:self.bodyStream]ï¼Œ å…¶ä»–ä»£ç å¥½æ‡‚ã€‚è¿™ä¸ªè®¾ç½®åï¼ŒHTTPBodyè¯·è¢«ç½®ç©ºï¼Œè¿™ä¸ªæµçš„å®Œæ•´æ•°æ®å°†è¢«ä½œä¸ºè¯·æ±‚ä½“ã€‚è¿™ä¸ªæµéœ€è¦æ˜¯è¿˜æ²¡æ‰“å¼€çš„ï¼Œrequestä¼šæ¥ç®¡è¿™ä¸ªæµï¼Œè¯·æ±‚æ—¶å€™ä¼šæ‰“å¼€ï¼Œä¸ç”¨æˆ‘ä»¬è°ƒæµçš„openã€‚å…³äºæµå¯ä»¥è¡¥ä¸€ä¸‹<a href="http://southpeak.github.io/blog/2014/07/17/ioszhong-liu-stream-de-shi-yong/" target="_blank" rel="noopener">è¿™ç¯‡</a>ï¼Œstackoverflowçœ‹åˆ°ä¸ªæ¯”è¾ƒä¸€é’ˆè§è¡€çš„æè¿°ï¼šThe thing you need to understand about NSStreams, is â€œdonâ€™t call us, weâ€™ll call you.â€ When the stream has data available, it will notify its delegate, and then you read whatever data is available and tell it to go get some more. ç„¶è€Œä¹Ÿæœ‰ä¸»åŠ¨call youçš„æƒ…å†µï¼ŒAFHTTPBodyPartå°±æ˜¯è¿™æ ·å¹²çš„ã€‚</p><p>ä¸‹é¢çœ‹æµæ˜¯å¦‚ä½•è¯»çš„ï¼Œä¸‹é¢æ˜¯AFMultipartBodyStreamçš„ä»£ç†æ–¹æ³•ï¼š</p><pre><code>- (<span class="built_in">NSInteger</span>)read:(uint8_t *)buffer        maxLength:(<span class="built_in">NSUInteger</span>)length{    <span class="built_in">NSInteger</span> totalNumberOfBytesRead = <span class="number">0</span>;    <span class="comment">//éå†æ¯ä¸ªAFHTTPBodyPartï¼Œæœ‰æ•°æ®å°±è¯»ï¼Œæ²¡æ•°æ®å°±è·³åˆ°ä¸‹ä¸€å—</span>    <span class="keyword">while</span> ((<span class="built_in">NSUInteger</span>)totalNumberOfBytesRead &lt; MIN(length, <span class="keyword">self</span><span class="variable">.numberOfBytesInPacket</span>)) {        <span class="keyword">if</span> (!<span class="keyword">self</span><span class="variable">.currentHTTPBodyPart</span> || ![<span class="keyword">self</span><span class="variable">.currentHTTPBodyPart</span> hasBytesAvailable]) {            <span class="keyword">if</span> (!(<span class="keyword">self</span><span class="variable">.currentHTTPBodyPart</span> = [<span class="keyword">self</span><span class="variable">.HTTPBodyPartEnumerator</span> nextObject])) {                <span class="keyword">break</span>;            }        } <span class="keyword">else</span> {            <span class="built_in">NSUInteger</span> maxLength = MIN(length, <span class="keyword">self</span><span class="variable">.numberOfBytesInPacket</span>) - (<span class="built_in">NSUInteger</span>)totalNumberOfBytesRead;            <span class="comment">//è¯»å–å½“å‰bodyPartçš„æµã€‚</span>            <span class="built_in">NSInteger</span> numberOfBytesRead = [<span class="keyword">self</span><span class="variable">.currentHTTPBodyPart</span> read:&amp;buffer[totalNumberOfBytesRead] maxLength:maxLength];            <span class="keyword">if</span> (numberOfBytesRead == -<span class="number">1</span>) {                <span class="keyword">self</span><span class="variable">.streamError</span> = <span class="keyword">self</span><span class="variable">.currentHTTPBodyPart</span><span class="variable">.inputStream</span><span class="variable">.streamError</span>;                <span class="keyword">break</span>;            } <span class="keyword">else</span> {                totalNumberOfBytesRead += numberOfBytesRead;                <span class="comment">//æ¯ä¸ªæ•°æ®å—è¯»å®Œè®¾å»¶æ—¶ï¼Œå¦‚æœæœ‰çš„è¯ï¼Œé¿å…"request body stream exhausted"ï¼Œé»˜è®¤æ— delayã€‚</span>                <span class="keyword">if</span> (<span class="keyword">self</span><span class="variable">.delay</span> &gt; <span class="number">0.0</span>f) {                    [<span class="built_in">NSThread</span> sleepForTimeInterval:<span class="keyword">self</span><span class="variable">.delay</span>];                }            }        }    }    <span class="keyword">return</span> totalNumberOfBytesRead;}</code></pre><p>AFHTTPBodyPartçš„æµè¯»å–æ–¹æ³•ï¼š</p><pre><code>- (<span class="built_in">NSInteger</span>)read:(uint8_t *)buffer        maxLength:(<span class="built_in">NSUInteger</span>)length{    <span class="built_in">NSInteger</span> totalNumberOfBytesRead = <span class="number">0</span>;    <span class="comment">//_phaseè¡¨ç¤ºå½“å‰å¤„äºæ•°æ®å—çš„å“ªå—å†…å®¹ï¼Œè¾¹ç•Œçº¿ã€headeræˆ–è€…æ•°æ®æ­£æ–‡ã€‚ã€‚</span>    <span class="comment">//è¯»å–èµ·å§‹åˆ†å‰²ç¬¦æˆ–è€…ä¸­é—´çš„åˆ†å‰²ç¬¦</span>    <span class="keyword">if</span> (_phase == AFEncapsulationBoundaryPhase) {        <span class="built_in">NSData</span> *encapsulationBoundaryData = [([<span class="keyword">self</span> hasInitialBoundary] ? AFMultipartFormInitialBoundary(<span class="keyword">self</span><span class="variable">.boundary</span>) : AFMultipartFormEncapsulationBoundary(<span class="keyword">self</span><span class="variable">.boundary</span>)) dataUsingEncoding:<span class="keyword">self</span><span class="variable">.stringEncoding</span>];        <span class="comment">//å°†dataè¯»åˆ°bufferï¼Œå¹¶ä¸”è·³è½¬åˆ°ä¸‹ä¸€ä¸ª_phase</span>        totalNumberOfBytesRead += [<span class="keyword">self</span> readData:encapsulationBoundaryData intoBuffer:&amp;buffer[totalNumberOfBytesRead] maxLength:(length - (<span class="built_in">NSUInteger</span>)totalNumberOfBytesRead)];    }    <span class="comment">//è¯»å–headeræ•°æ®</span>    <span class="keyword">if</span> (_phase == AFHeaderPhase) {        <span class="comment">//å°†dataè¯»åˆ°bufferï¼Œå¹¶ä¸”è·³è½¬åˆ°ä¸‹ä¸€ä¸ª_phase</span>        <span class="built_in">NSData</span> *headersData = [[<span class="keyword">self</span> stringForHeaders] dataUsingEncoding:<span class="keyword">self</span><span class="variable">.stringEncoding</span>];        totalNumberOfBytesRead += [<span class="keyword">self</span> readData:headersData intoBuffer:&amp;buffer[totalNumberOfBytesRead] maxLength:(length - (<span class="built_in">NSUInteger</span>)totalNumberOfBytesRead)];    }    <span class="comment">//è¯»å–æ•°æ®æ­£æ–‡</span>    <span class="keyword">if</span> (_phase == AFBodyPhase) {        <span class="built_in">NSInteger</span> numberOfBytesRead = <span class="number">0</span>;        <span class="comment">//è¿™ä¸ªæ•°æ®æ­£æ–‡inputStreamå°±æ˜¯ä¸»åŠ¨å»read.</span>        numberOfBytesRead = [<span class="keyword">self</span><span class="variable">.inputStream</span> read:&amp;buffer[totalNumberOfBytesRead] maxLength:(length - (<span class="built_in">NSUInteger</span>)totalNumberOfBytesRead)];        <span class="keyword">if</span> (numberOfBytesRead == -<span class="number">1</span>) {            <span class="keyword">return</span> -<span class="number">1</span>;        } <span class="keyword">else</span> {            totalNumberOfBytesRead += numberOfBytesRead;            <span class="keyword">if</span> ([<span class="keyword">self</span><span class="variable">.inputStream</span> streamStatus] &gt;= <span class="built_in">NSStreamStatusAtEnd</span>) {                [<span class="keyword">self</span> transitionToNextPhase];            }        }    }    <span class="comment">//åˆ¤æ–­æ˜¯å¦æ˜¯æœ€åä¸€ä¸ªæ•°æ®å—ï¼Œæ˜¯çš„è¯åŠ ä¸Šåˆ†å‰²ç¬¦</span>    <span class="keyword">if</span> (_phase == AFFinalBoundaryPhase) {        <span class="built_in">NSData</span> *closingBoundaryData = ([<span class="keyword">self</span> hasFinalBoundary] ? [AFMultipartFormFinalBoundary(<span class="keyword">self</span><span class="variable">.boundary</span>) dataUsingEncoding:<span class="keyword">self</span><span class="variable">.stringEncoding</span>] : [<span class="built_in">NSData</span> data]);        totalNumberOfBytesRead += [<span class="keyword">self</span> readData:closingBoundaryData intoBuffer:&amp;buffer[totalNumberOfBytesRead] maxLength:(length - (<span class="built_in">NSUInteger</span>)totalNumberOfBytesRead)];    }    <span class="keyword">return</span> totalNumberOfBytesRead;}</code></pre><p>ä»¥ä¸Šå°±æ˜¯åˆ†å—æ•°æ®ä¸Šä¼ çš„å†…å®¹ã€‚è¯»å®Œæºç ï¼Œå‘ç°ç„¶è€Œä»æ¥æ²¡ç”¨è¿‡è¿™ä¸ªåŠŸèƒ½- -ã€‚é¿å…çŸ¥è¯†ç”¨åˆ°æ–¹æ¨å°‘æ—¶ï¼Œçœ‹çœ‹ä¹Ÿæ˜¯å€¼å¾—çš„ã€‚</p><h2 id="AFURLResponseSerialization">AFURLResponseSerialization</h2><p>è¯·æ±‚çš„å“åº”åˆ™å•çº¯çš„å¤šï¼Œæ¯”è¾ƒç®€å•ï¼Œæ— éå°±æ˜¯çŠ¶æ€åˆ¤æ–­ï¼ŒMIMEåˆ¤æ–­ï¼Œä¸åŒç±»å‹æ•°æ®çš„å¤„ç†ã€‚</p><p><img src="/images/af_response.png" alt></p><p>åŸºç±»AFHTTPResponseSerializerå®ç°æ•°æ®æ˜¯å¦æœ‰æ•ˆçš„æ ¡éªŒï¼Œæ•°æ®ä¸åšå¤„ç†ï¼ŒåŸæ ·è¿”å›dataã€‚å‡ ä¸ªå­ç±»åˆ™æœ‰å¯¹åº”çš„æ•°æ®å¤„ç†æ–¹æ³•ï¼Œå€¼å¾—ä¸€æçš„æ˜¯JSONæ•°æ®æœ‰å¸®æˆ‘ä»¬åšäº†ä¸€äº›ç©ºå­—æ®µå¤„ç†ã€‚</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;ç»§ç»­AFNetworkingç¬”è®°ã€‚æœ¬ç¯‡ä¸»è¦å…³äºNSURLRequestçš„ç”Ÿæˆï¼Œè¯·æ±‚å›æ¥å“åº”çš„å¤„ç†ã€‚&lt;/p&gt;
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>AFNetworkingæºç é˜…è¯»ç¬”è®°ä¹‹ä¸€</title>
    <link href="https://github.com/zhuangxq/zhuangxq.github.io.git/2016/06/25/AFNetworking%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0%E4%B9%8B%E4%B8%80/"/>
    <id>https://github.com/zhuangxq/zhuangxq.github.io.git/2016/06/25/AFNetworkingæºç é˜…è¯»ç¬”è®°ä¹‹ä¸€/</id>
    <published>2016-06-25T02:03:40.000Z</published>
    <updated>2019-10-27T08:25:22.873Z</updated>
    
    <content type="html"><![CDATA[<p>å­¦ä¹ <a href="https://github.com/AFNetworking/AFNetworking">AFNetworking</a>å‰ï¼Œæœ€å¥½å…ˆäº†è§£ä¸‹<a href="http://objccn.io/issue-5-4/" target="_blank" rel="noopener">NSURLSession</a>ã€‚æœ¬æ–‡å…ˆä»‹ç»ä¸€ä¸‹AFNetworkingå¦‚ä½•å·¥ä½œï¼Œæ•´ä½“ç»“æ„æ˜¯æ€æ ·çš„ã€‚å…ˆçœ‹æ¶æ„å›¾ï¼š</p><p><img src="/images/AFSummary.png" alt></p><p>AFURLSessionManagerä¸ºæ ¸å¿ƒç±»ï¼Œç±»ä¼¼äºMVCä¸­çš„controllerï¼Œè´Ÿè´£ç»„ç»‡èµ·æ•´ä¸ªå·¥ä½œæµç¨‹ï¼Œè¿™é‡Œå®ƒè¦ç®¡çš„æœ‰AFHTTPRequestSerializerè¯·æ±‚çš„ç”Ÿæˆï¼ŒAFHTTPResponseSerializerå“åº”å¤„ç†çš„ç”Ÿæˆï¼ŒNSURLSessionçš„ç®¡ç†ï¼Œè¯·æ±‚taskçš„å„ç§å„æ ·å›è°ƒå¤„ç†ï¼ŒAFSecurityPolicyå®‰å…¨ç­–ç•¥é…ç½®ã€ç¼“å­˜ç­–ç•¥é…ç½®ç­‰ã€‚ä¸‹é¢é€šè¿‡ä¸€ä¸ªæ™®é€šGETè¯·æ±‚å‡½æ•°è°ƒç”¨æ ˆï¼Œäº†è§£ä¸‹æ•´å¥—æµç¨‹ï¼Œåˆ†ä¸‰éƒ¨åˆ†ï¼šè¯·æ±‚å‰ã€è¯·æ±‚ä¸­ã€è¯·æ±‚åã€‚</p><a id="more"></a><p>è¯·æ±‚å‰(in main queue)ï¼š</p><pre><code>[AFHTTPSessionManager <span class="string">GET:</span><span class="string">parameters:</span><span class="string">progress:</span><span class="string">success:</span><span class="string">failure:</span>]  [AFHTTPSessionManager <span class="string">dataTaskWithHTTPMethod:</span><span class="string">URLString:</span><span class="string">parameters:</span><span class="string">uploadProgress:</span><span class="string">downloadProgress:</span><span class="string">success:</span><span class="string">failure:</span>]    [AFHTTPRequestSerializer <span class="string">requestWithMethod:</span><span class="string">URLString:</span><span class="string">parameters:</span><span class="string">error:</span>]   #<span class="number">1</span>    [AFHTTPRequestSerializer <span class="string">requestBySerializingRequest:</span><span class="string">withParameters:</span><span class="string">error:</span>] #<span class="number">1</span>    [AFURLSessionManager <span class="string">dataTaskWithRequest:</span><span class="string">uploadProgress:</span><span class="string">downloadProgress:</span><span class="string">completionHandler:</span>]  #<span class="number">2</span>        [AFURLSessionManager <span class="string">addDelegateForDataTask:</span><span class="string">uploadProgress:</span><span class="string">downloadProgress:</span><span class="string">completionHandler:</span>]          [AFURLSessionManager <span class="string">setDelegate:</span><span class="string">forTask:</span>]        [AFURLSessionManager <span class="string">addNotificationObserverForTask:</span>]  [task resume]  #<span class="number">3</span></code></pre><p>AFHTTPSessionManageræ˜¯AFURLSessionManagerçš„å­ç±»ï¼Œæä¾›æ›´æ–¹ä¾¿çš„æ¥å£ã€‚#1æ˜¯æ ¹æ®URLã€è¯·æ±‚å‚æ•°ç”ŸæˆNSMutableURLRequestï¼Œç”Ÿæˆå·¥ä½œç”±AFHTTPRequestSerializeræ¥åšã€‚#2å°±æ˜¯åˆ›å»ºNSURLSessionDataTaskï¼ŒåŒæ—¶ä¹Ÿåšäº†ä¸€äº›ä»£ç†æ·»åŠ è®¾ç½®(ä»£ç†ã€å›è°ƒblockç®¡ç†ä¸‹é¢è®²)ã€‚#3[task resume]è¯·æ±‚æ­£å¼å¼€å§‹ã€‚</p><p>è¯·æ±‚ä¸­(not in main thread)ï¼š</p><pre><code>[AFURLSessionManager <span class="string">URLSession:</span><span class="string">didReceiveChallenge:</span><span class="string">completionHandler:</span>] #<span class="number">1</span>    [AFSecurityPolicy <span class="string">evaluateServerTrust:</span><span class="string">forDomain:</span>] #<span class="number">1</span>        AFServerTrustIsValid  #<span class="number">1</span>[AFURLSessionManager <span class="string">URLSession:</span><span class="string">dataTask:</span><span class="string">didReceiveData:</span>] #<span class="number">2</span>    [AFURLSessionManagerTaskDelegate <span class="string">URLSession:</span><span class="string">dataTask:</span><span class="string">didReceiveData:</span>] #<span class="number">3</span>[AFURLSessionManager <span class="string">URLSession:</span><span class="string">task:</span><span class="string">didCompleteWithError:</span>] #<span class="number">4</span>[AFURLSessionManagerTaskDelegate <span class="string">URLSession:</span><span class="string">task:</span><span class="string">didCompleteWithError:</span>] #<span class="number">4</span>[AFURLSessionManager <span class="string">removeDelegateForTask:</span>]</code></pre><p>ç¬¬ä¸€ä¸ªå°éƒ¨åˆ†#1æ˜¯httpsçš„è¯ä¹¦æ ¡éªŒ(æ˜å¹´è‚¯å®šæ˜¯éƒ½è¦httpsäº†â€¦),è¿™éƒ¨åˆ†å†…å®¹å‡†å¤‡å¦å¤–å†™ä¸€ç¯‡ã€‚#2å°±æ˜¯æ•°æ®æ¥æ”¶ã€‚#3çš„AFURLSessionManagerTaskDelegateæ˜¯ä»£ç†ç®¡ç†çš„ä¸€ä¸ªç±»ï¼Œä¸‹é¢å•ç‹¬è®²ã€‚ #4æ•°æ®æ¥æ”¶å®Œæˆï¼Œè¯·æ±‚ç»“æŸï¼Œæœ‰é”™è¯¯å°±å“åº”é”™è¯¯ï¼Œæ²¡é”™è¯¯å°±å»å¤„ç†æ•°æ®ã€‚</p><p>è¯·æ±‚å(in queue: com.alamofire.networking.session.manager.processing)ï¼š</p><pre><code>[AFJSONResponseSerializer <span class="string">responseObjectForResponse:</span><span class="string">data:</span><span class="string">error:</span>]    [AFHTTPResponseSerializer <span class="string">validateResponse:</span><span class="string">data:</span><span class="string">error:</span>]</code></pre><p>è¯·æ±‚åè¿™ä¿©å°±æ˜¯æ•°æ®çš„æ ¡éªŒå’Œæ•°æ®çš„å¤„ç†ã€‚AFJSONResponseSerializerç»§æ‰¿è‡ªAFHTTPResponseSerializer,å¤„ç†JSONæ•°æ®ã€‚æ•°æ®å¤„ç†å®Œï¼Œå›ä¸»çº¿ç¨‹ï¼Œsuccess(failure) blockå›è°ƒã€‚æµç¨‹ç»“æŸã€‚</p><p>ä¸‹é¢çœ‹ä¸‹ä¸Šé¢æåˆ°çš„AFURLSessionManagerTaskDelegateï¼Œä»£ç†å›è°ƒã€blockéƒ½æ˜¯æ€ä¹ˆå¤„ç†çš„ï¼Ÿè¯·æ±‚å‰#2æœ‰ä¸ªaddDelegateå‡½æ•°ï¼š</p><pre><code>- (<span class="keyword">void</span>)addDelegateForDataTask:(<span class="built_in">NSURLSessionDataTask</span> *)dataTask                uploadProgress:(nullable <span class="keyword">void</span> (^)(<span class="built_in">NSProgress</span> *uploadProgress)) uploadProgressBlock              downloadProgress:(nullable <span class="keyword">void</span> (^)(<span class="built_in">NSProgress</span> *downloadProgress)) downloadProgressBlock             completionHandler:(<span class="keyword">void</span> (^)(<span class="built_in">NSURLResponse</span> *response, <span class="keyword">id</span> responseObject, <span class="built_in">NSError</span> *error))completionHandler{    <span class="comment">//åˆ›å»ºä»£ç†ç®¡ç†å¯¹è±¡ï¼Œå¹¶å°†ä¸‰ä¸ªblockäº¤ç»™è¿™ä¸ªå¯¹è±¡ã€‚</span>    AFURLSessionManagerTaskDelegate *delegate = [[AFURLSessionManagerTaskDelegate alloc] init];    delegate<span class="variable">.manager</span> = <span class="keyword">self</span>;    <span class="comment">//æŒæœ‰AFURLSessionManager</span>    delegate<span class="variable">.completionHandler</span> = completionHandler;    dataTask<span class="variable">.taskDescription</span> = <span class="keyword">self</span><span class="variable">.taskDescriptionForSessionTasks</span>;    [<span class="keyword">self</span> setDelegate:delegate forTask:dataTask];    delegate<span class="variable">.uploadProgressBlock</span> = uploadProgressBlock;    delegate<span class="variable">.downloadProgressBlock</span> = downloadProgressBlock;}- (<span class="keyword">void</span>)setDelegate:(AFURLSessionManagerTaskDelegate *)delegate            forTask:(<span class="built_in">NSURLSessionTask</span> *)task{    <span class="built_in">NSParameterAssert</span>(task);    <span class="built_in">NSParameterAssert</span>(delegate);    [<span class="keyword">self</span><span class="variable">.lock</span> lock];    <span class="comment">//taskå’Œdelegate managerä»¥é”®å€¼å¯¹æ–¹å¼å­˜åœ¨è¿™ä¸ªå­—å…¸ã€‚</span>    <span class="keyword">self</span><span class="variable">.mutableTaskDelegatesKeyedByTaskIdentifier</span>[@(task<span class="variable">.taskIdentifier</span>)] = delegate;    [delegate setupProgressForTask:task];    <span class="comment">//è¿›åº¦å›è°ƒè®¾ç½®ï¼Œç”¨KVOè§‚å¯Ÿtaskçš„å‡ ä¸ªè¿›åº¦å€¼ã€‚</span>    [<span class="keyword">self</span> addNotificationObserverForTask:task];    [<span class="keyword">self</span><span class="variable">.lock</span> unlock];}</code></pre><p>ä»ä¸Šé¢ä»£ç å¯ä»¥çœ‹å‡ºï¼ŒAFURLSessionManagerçš„è¿›åº¦å›è°ƒå’Œå®ŒæˆcompletionHandleéƒ½æ˜¯äº¤ç»™äº†è¿™ä¸ªä»£ç†ç®¡ç†ç±»ã€‚å†çœ‹ä¸‹è¿™ä¸ªç±»çš„@interfaceã€‚</p><pre><code><span class="class"><span class="keyword">@interface</span> <span class="title">AFURLSessionManagerTaskDelegate</span> : <span class="title">NSObject</span> &lt;<span class="title">NSURLSessionTaskDelegate</span>, <span class="title">NSURLSessionDataDelegate</span>, <span class="title">NSURLSessionDownloadDelegate</span>&gt;</span><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">weak</span>) AFURLSessionManager *manager;<span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSMutableData</span> *mutableData;<span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSProgress</span> *uploadProgress;<span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSProgress</span> *downloadProgress;<span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) <span class="built_in">NSURL</span> *downloadFileURL;<span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) AFURLSessionDownloadTaskDidFinishDownloadingBlock downloadTaskDidFinishDownloading;<span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) AFURLSessionTaskProgressBlock uploadProgressBlock;<span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) AFURLSessionTaskProgressBlock downloadProgressBlock;<span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">copy</span>) AFURLSessionTaskCompletionHandler completionHandler;<span class="keyword">@end</span></code></pre><p>å¯è§ä¸»è¦çš„å›è°ƒæ•°æ®éƒ½äº¤ç»™äº†è¿™ä¸ªç±»ï¼ŒåŒ…æ‹¬å›è°ƒdataï¼Œä¸‹è½½çš„fileURLã€‚è¿™ä¸ªç±»å®ç°äº†ä¸‰ä¸ªåè®®çš„ä¸‰ä¸ªæ–¹æ³•ï¼Œåˆ†åˆ«æ˜¯æ•°æ®æ¥æ”¶didReceiveDataï¼Œè¯·æ±‚å®ŒæˆdidCompleteWithErrorï¼Œ ä¸‹è½½å®ŒæˆdidFinishDownloadingToURLã€‚æ‰€ä»¥è¿™ä¸ªç±»æ¥ç®¡äº†è¿›åº¦å’Œå®Œæˆå›è°ƒï¼Œå¤„ç†äº†å›è°ƒæ•°æ®ï¼Œæœ€åå®Œæˆblockä¹Ÿåœ¨æ­¤ã€‚è¿™é‡Œä¸‰ä¸ªåè®®æ–¹æ³•ï¼Œä»…ä»…å°±æ˜¯æä¾›ä¸‰ä¸ªæ–¹æ³•è€Œå·²,NSURLSessionç›¸å…³çš„ä»£ç†å¹¶ä¸æ˜¯ç›´æ¥å›è°ƒè¿™ä¸‰å‡½æ•°ï¼Œè¿™ä¸‰å‡½æ•°æ˜¯åœ¨AFURLSessionManagerä¸­çš„ä»£ç†ä¸­è°ƒç”¨ã€‚æ¢å¥è¯ï¼Œè¿™ä¸‰æ–¹æ³•ä½ éšä¾¿æ¢ä¸ªåå­—ä¹Ÿæ²¡å•¥é—®é¢˜ï¼Œå°±æ˜¯ä¸ªæ™®é€šæ–¹æ³•ã€‚è¿™é‡Œå®¹æ˜“æ··æ·†ã€‚</p><p>å¦å¤–ï¼Œè¿™é‡Œä¸ºä»€ä¹ˆè¦æŠŠè¿›åº¦ã€å›è°ƒæ•°æ®ã€æ•°æ®å¤„ç†è¿™å—å•ç‹¬æ‹†å‡ºæ¥ï¼Ÿä¸ªäººçä»¥ä¸ºï¼šè¿™æ ·ç±»çš„èŒèƒ½æ›´æ¸…æ™°ï¼ŒAFURLSessionManagerå°±æ˜¯åšç½‘ç»œè¯·æ±‚çš„äº‹ï¼Œè¯·æ±‚è¿›åº¦ç®¡ç†ã€è¯·æ±‚å›æ¥çš„åäº‹å°±æ˜¯äº¤ç»™AFURLSessionManagerTaskDelegateï¼Œæ‹†å¼€çš„ä¸€ä¸ªå¥½å¤„å°±æ˜¯å¯æ‹“å±•æ€§å¢å¼ºï¼Œæƒ³è¦æ›¿æ¢æˆ–è€…å¢åŠ ä¸€ä¸ªåäº‹å¤„ç†ç±»å‹å°±æ¯”è¾ƒå®¹æ˜“äº†ã€‚ä¸è¿‡ä¹Ÿæƒ³ä¸å‡ºè¿™é‡Œè¿˜éœ€è¦æ‰©å±•å‡ºä»€ä¹ˆä¸œè¥¿ï¼Œæˆ–è€…ä¹Ÿä»…ä»…åªæ˜¯æƒ³åšä¸ªä»£ç æ‹†åˆ†è€Œå·²ã€‚</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;å­¦ä¹ &lt;a href=&quot;https://github.com/AFNetworking/AFNetworking&quot;&gt;AFNetworking&lt;/a&gt;å‰ï¼Œæœ€å¥½å…ˆäº†è§£ä¸‹&lt;a href=&quot;http://objccn.io/issue-5-4/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;NSURLSession&lt;/a&gt;ã€‚æœ¬æ–‡å…ˆä»‹ç»ä¸€ä¸‹AFNetworkingå¦‚ä½•å·¥ä½œï¼Œæ•´ä½“ç»“æ„æ˜¯æ€æ ·çš„ã€‚å…ˆçœ‹æ¶æ„å›¾ï¼š&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;/images/AFSummary.png&quot; alt&gt;&lt;/p&gt;
&lt;p&gt;AFURLSessionManagerä¸ºæ ¸å¿ƒç±»ï¼Œç±»ä¼¼äºMVCä¸­çš„controllerï¼Œè´Ÿè´£ç»„ç»‡èµ·æ•´ä¸ªå·¥ä½œæµç¨‹ï¼Œè¿™é‡Œå®ƒè¦ç®¡çš„æœ‰AFHTTPRequestSerializerè¯·æ±‚çš„ç”Ÿæˆï¼ŒAFHTTPResponseSerializerå“åº”å¤„ç†çš„ç”Ÿæˆï¼ŒNSURLSessionçš„ç®¡ç†ï¼Œè¯·æ±‚taskçš„å„ç§å„æ ·å›è°ƒå¤„ç†ï¼ŒAFSecurityPolicyå®‰å…¨ç­–ç•¥é…ç½®ã€ç¼“å­˜ç­–ç•¥é…ç½®ç­‰ã€‚ä¸‹é¢é€šè¿‡ä¸€ä¸ªæ™®é€šGETè¯·æ±‚å‡½æ•°è°ƒç”¨æ ˆï¼Œäº†è§£ä¸‹æ•´å¥—æµç¨‹ï¼Œåˆ†ä¸‰éƒ¨åˆ†ï¼šè¯·æ±‚å‰ã€è¯·æ±‚ä¸­ã€è¯·æ±‚åã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="AFNetworking" scheme="https://github.com/zhuangxq/zhuangxq.github.io.git/tags/AFNetworking/"/>
    
  </entry>
  
  <entry>
    <title>Masonryæºç å­¦ä¹ </title>
    <link href="https://github.com/zhuangxq/zhuangxq.github.io.git/2016/03/24/Masonry%E5%AD%A6%E4%B9%A0/"/>
    <id>https://github.com/zhuangxq/zhuangxq.github.io.git/2016/03/24/Masonryå­¦ä¹ /</id>
    <published>2016-03-24T12:33:49.000Z</published>
    <updated>2019-10-27T08:25:55.206Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Overview">Overview</h2><p>Masonryå·²ç»æ˜¯ç¦»ä¸å¼€çš„å¼€å‘åº“äº†ï¼Œæ‰€æœ‰å¸ƒå±€éƒ½ç”¨å®ƒï¼Œè®°å½•ä¸€ä¸‹<a href="https://github.com/SnapKit/Masonry">Masonary</a>çš„æºç å­¦ä¹ ã€‚å¸¦ç€å‡ ä¸ªé—®é¢˜å¼€å§‹ã€‚</p><ul><li>Masonryæ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Ÿ</li><li>é“¾å¼è°ƒç”¨çš„è¯­æ³•æ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿ</li><li>ä½¿ç”¨æ³¨æ„é¡¹ï¼Ÿ</li></ul><a id="more"></a><h3 id="å·¥ä½œæµç¨‹">å·¥ä½œæµç¨‹</h3><p>Masonryç›®å½•ï¼Œçº¢æ¡†å†…ä¸ºä¸»è¦ç±»ã€‚<br><img src="/images/masonry_1.png" alt></p><p>MASConstraints:æ ¸å¿ƒç±»ï¼Œå¯ä»¥è¡¨ç¤ºNSLayoutConstraintçš„ä¿¡æ¯ï¼Œå¯ä»¥æ˜¯ä¸€ä¸ªæˆ–ä¸€ç»„çº¦æŸã€‚åˆ†åˆ«å¯¹åº”ä¸¤ä¸ªå­ç±»MASViewConstraintsï¼ŒMASCompositeConstraintã€‚é“¾å¼è°ƒç”¨çš„å®ç°ä¹Ÿæ¥è‡ªè¿™ä¸ªç±»ã€‚ä¸‹æ–‡åˆ†æã€‚</p><p>MASViewConstraints:MASConstraintså­ç±»ï¼ŒåŒ…å«ä¸€ä¸ªçº¦æŸçš„ç›¸å…³ä¿¡æ¯ï¼Œfirst/second MASViewAttribute, layoutRelationã€‚æä¾›å®‰è£…ã€å¸è½½çº¦æŸçš„æ–¹æ³•ã€‚ä¸‹æ–‡â€œçº¦æŸâ€éƒ½æŒ‡MASViewConstraintsã€‚</p><p>MASCompositeConstraint:MASConstraintså­ç±»ï¼ŒåŒ…å«å¤šä¸ªMASViewConstraintsã€‚ä¸‹æ–‡ç§°ä¹‹ä¸ºâ€çº¦æŸé›†â€ã€‚</p><p>MASViewAttribute:å­˜å‚¨NSLayoutAttributeä¿¡æ¯ï¼Œå’Œå…¶å¯¹åº”çš„viewã€‚</p><p>MASConstraintMaker:å¦‚å…¶åï¼Œè¿™æ˜¯ä¸€ä¸ªmaker(åºŸè¯ï¼)ã€‚è¿™ç›¸å½“äºä¸€ä¸ªå‘åŠ¨æœºï¼Œè´Ÿè´£ç”Ÿäº§çº¦æŸï¼Œå¹¶è®©çº¦æŸå·¥ä½œèµ·æ¥ã€‚</p><p>å…ˆçœ‹ä¸€æ®µä»£ç ï¼Œè¿™ä¸ªæˆ‘ä»¬å†ç†Ÿæ‚‰ä¸è¿‡ã€‚mas_ä¸€æ•²ï¼Œå›è½¦ä¸€æŒ‰ï¼Œè°ƒçš„å°±æ˜¯å®ƒï¼</p><pre><code>- (<span class="built_in">NSArray</span> *)mas_makeConstraints:(<span class="keyword">void</span>(^)(MASConstraintMaker *))block {    <span class="keyword">self</span><span class="variable">.translatesAutoresizingMaskIntoConstraints</span> = <span class="literal">NO</span>;    MASConstraintMaker *constraintMaker = [[MASConstraintMaker alloc] initWithView:<span class="keyword">self</span>];    block(constraintMaker);    <span class="keyword">return</span> [constraintMaker install];}</code></pre><p>Masonryå·¥ä½œå…¥å£åœ¨æ­¤ï¼Œåˆ›å»ºä¸€ä¸ªå‘åŠ¨æœºMASConstraintMaker, block(constraintMaker)çš„ä½œç”¨åˆ™æ˜¯åˆ›å»ºçº¦æŸã€‚å†çœ‹è¿™ä¸ªæ–¹æ³•çš„è°ƒç”¨ï¼š</p><pre><code><span class="collection">[topView mas_makeConstraints:^<span class="list">(<span class="keyword">MASConstraintMaker</span> *make)</span> <span class="collection">{    make.top.equalTo<span class="list">(<span class="keyword">self.view</span>)</span>.offSet<span class="list">(<span class="number">10</span>)</span><span class="comment">;</span>    make.left.right.equalTo<span class="list">(<span class="keyword">self.view</span>)</span><span class="comment">;</span>    make.bottom.equalTo<span class="list">(<span class="keyword">self.view</span>)</span><span class="comment">;</span>}</span>]</span><span class="comment">;</span></code></pre><p>make.bottom.equalTo(self.view)å°±æ˜¯åˆ›å»ºä¸€æ¡MASViewConstraintsçº¦æŸï¼Œmake.left.right.equalTo(self.view)åˆ›å»ºä¸€æ¡MASCompositeConstraintçº¦æŸ(åŒ…å«ä¸¤æ¡MASViewConstraintsçº¦æŸ)ã€‚ç»“åˆä¸Šé¢ä¸¤æ®µä»£ç çœ‹å‡ºï¼Œblock(constraintMaker)å°±æ˜¯é€šè¿‡makeråˆ›å»ºçº¦æŸï¼Œæ¯æ¡çº¦æŸä¼šå­˜å®‰è£…ä¸€æ¡NSLayoutConstraintçš„æ‰€æœ‰ä¿¡æ¯(åŒ…æ‹¬firsetItem, secondItem, firstAttribute, secondAttribute, layoutRelation, priority, constantç­‰ã€‚)</p><p>æ¥ç€çœ‹ä¸‹make.top.equalTo(self.view)å¦‚ä½•äº§ç”Ÿä¸€æ¡çº¦æŸã€‚make.topæ‰§è¡Œçš„ä¸‰ä¸ªå‡½æ•°ã€‚</p><pre><code>- (MASConstraint *)top {    <span class="keyword">return</span> [self <span class="string">addConstraintWithLayoutAttribute:</span>NSLayoutAttributeTop];}- (MASConstraint *)<span class="string">addConstraintWithLayoutAttribute:</span>(NSLayoutAttribute)layoutAttribute {    <span class="keyword">return</span> [self <span class="string">constraint:</span>nil <span class="string">addConstraintWithLayoutAttribute:</span>layoutAttribute];}- (MASConstraint *)<span class="string">constraint:</span>(MASConstraint *)constraint <span class="string">addConstraintWithLayoutAttribute:</span>(NSLayoutAttribute)layoutAttribute {    MASViewAttribute *viewAttribute = [[MASViewAttribute alloc] <span class="string">initWithView:</span>self.view <span class="string">layoutAttribute:</span>layoutAttribute];    MASViewConstraint *newConstraint = [[MASViewConstraint alloc] <span class="string">initWithFirstViewAttribute:</span>viewAttribute];    <span class="keyword">if</span> ([constraint <span class="string">isKindOfClass:</span>MASViewConstraint.<span class="keyword">class</span>]) {        <span class="comment">//replace with composite constraint</span>        NSArray *children = @[constraint, newConstraint];        MASCompositeConstraint *compositeConstraint = [[MASCompositeConstraint alloc] <span class="string">initWithChildren:</span>children];        compositeConstraint.delegate = self;        [self <span class="string">constraint:</span>constraint <span class="string">shouldBeReplacedWithConstraint:</span>compositeConstraint];        <span class="keyword">return</span> compositeConstraint;    }    <span class="keyword">if</span> (!constraint) {        newConstraint.delegate = self;        [self.constraints <span class="string">addObject:</span>newConstraint];    }    <span class="keyword">return</span> newConstraint;}</code></pre><p>çœ‹å¾—å‡ºæœ€ç»ˆreturn çš„æ˜¯newConstraintï¼Œä¸€ä¸ªMASViewConstraintã€‚å¤§è‡´è¿‡ç¨‹ï¼šåˆ›å»ºä¸€ä¸ªåŒ…å«viewæ˜¯firstItemï¼Œattributeæ˜¯NSLayoutAttributeTopçš„MASViewAttributeï¼Œå†é€šè¿‡è¿™ä¸ªMASViewAttributeåˆ›å»ºä¸€ä¸ªçº¦æŸã€‚å¹¶è¿”å›è¿™ä¸ªçº¦æŸã€‚è¿™é‡Œæœ‰ä¸ªé‡è¦ä¿¡æ¯, ä¸ç®¡åˆ›å»ºçš„æ˜¯çº¦æŸæˆ–è€…çº¦æŸé›†ï¼Œå®ƒä»¬éƒ½æœ‰ä¸ªdelegateæŒ‡å‘makerã€‚è¿™æ˜¯åé¢é“¾å¼è¯­æ³•çš„å…³é”®ç‚¹ã€‚å¦ä¸€ä¸ªæ²¡é‚£ä¹ˆé‡è¦ä¿¡æ¯æ˜¯Masonryåªåœ¨è¿™ä¸ªåœ°æ–¹åˆ›å»ºçº¦æŸæˆ–çº¦æŸé›†ã€‚make.topæ‰§è¡Œå®Œæ¯•ï¼Œè¿”å›ä¸€ä¸ªçº¦æŸï¼Œæ¥ç€çœ‹çœ‹.equalToåšäº†ä»€ä¹ˆã€‚</p><pre><code>- (MASConstraint * (^)(<span class="keyword">id</span>))equalTo {    <span class="keyword">return</span> ^<span class="keyword">id</span>(<span class="keyword">id</span> attribute) {        <span class="keyword">return</span> <span class="keyword">self</span><span class="variable">.equalToWithRelation</span>(attribute, <span class="built_in">NSLayoutRelationEqual</span>);    };}- (MASConstraint * (^)(<span class="keyword">id</span>, <span class="built_in">NSLayoutRelation</span>))equalToWithRelation {    <span class="keyword">return</span> ^<span class="keyword">id</span>(<span class="keyword">id</span> attribute, <span class="built_in">NSLayoutRelation</span> relation) {        <span class="keyword">if</span> ([attribute isKindOfClass:<span class="built_in">NSArray</span><span class="variable">.class</span>]) {            <span class="built_in">NSAssert</span>(!<span class="keyword">self</span><span class="variable">.hasLayoutRelation</span>, <span class="string">@"Redefinition of constraint relation"</span>);            <span class="built_in">NSMutableArray</span> *children = <span class="built_in">NSMutableArray</span><span class="variable">.new</span>;            <span class="keyword">for</span> (<span class="keyword">id</span> attr <span class="keyword">in</span> attribute) {                MASViewConstraint *viewConstraint = [<span class="keyword">self</span> <span class="keyword">copy</span>];                viewConstraint<span class="variable">.secondViewAttribute</span> = attr;                [children addObject:viewConstraint];            }            MASCompositeConstraint *compositeConstraint = [[MASCompositeConstraint alloc] initWithChildren:children];            compositeConstraint<span class="variable">.delegate</span> = <span class="keyword">self</span><span class="variable">.delegate</span>;            [<span class="keyword">self</span><span class="variable">.delegate</span> constraint:<span class="keyword">self</span> shouldBeReplacedWithConstraint:compositeConstraint];            <span class="keyword">return</span> compositeConstraint;        } <span class="keyword">else</span> {            <span class="built_in">NSAssert</span>(!<span class="keyword">self</span><span class="variable">.hasLayoutRelation</span> || <span class="keyword">self</span><span class="variable">.layoutRelation</span> == relation &amp;&amp; [attribute isKindOfClass:<span class="built_in">NSValue</span><span class="variable">.class</span>], <span class="string">@"Redefinition of constraint relation"</span>);            <span class="keyword">self</span><span class="variable">.layoutRelation</span> = relation;            <span class="keyword">self</span><span class="variable">.secondViewAttribute</span> = attribute;            <span class="keyword">return</span> <span class="keyword">self</span>;        }    };}</code></pre><p>ä¸¤ä¸ªå‡½æ•°ï¼Œå…ˆçœ‹ç¬¬ä¸€è¡Œå’Œæœ€åä¸€è¡Œï¼Œç¬¬ä¸€è¡ŒequalToè¿”å›çš„æ˜¯ä¸€ä¸ªblockï¼Œæœ€åä¸€è¡Œblockä¸­return self, æ‰§è¡Œblockè¿”å›çš„æ˜¯å°±æ˜¯selfçº¦æŸæœ¬èº«ï¼Œæœ‰ä»€ä¹ˆç”¨ï¼Ÿåé¢å¯ä»¥æ¥ç€å†ç”¨.offSet.priorityç­‰åšå…¶ä»–è®¾ç½®ã€‚è¿™é‡Œblockæ€ä¹ˆç”¨çš„æ¥ç€ï¼šä¾›å¤–ç•Œä¼ å…¥å‚æ•°ï¼Œåœ¨é‡Œå¤´ç”¨å‚æ•°è¿›è¡Œä¸€äº›è®¾ç½®ï¼Œå†è¿”å›çº¦æŸæœ¬èº«ï¼Œåé¢ç»§ç»­è°ƒç”¨ã€‚ï¼ˆä¸ç®¡æœ‰å¤šå°‘å‚æ•°è¦è®¾ç½®ï¼Œéƒ½å¯ä»¥ç”¨è¿™ç§å‚æ•°ä¸€ç›´.ä¸‹å»ã€‚ï¼‰å†çœ‹è¿™ä¸ªblocké‡Œé¢åšäº†ä»€ä¹ˆäº‹æƒ…ï¼Œself.secondViewAttribute = attributeï¼Œè®¾ç½®çº¦æŸçš„secondViewAttribute,(ps:è¿™é‡Œä¼ å…¥çš„attributeæ˜¯UIViewï¼Œåœ¨setterå‡½æ•°é‡Œä¼šè‡ªåŠ¨ç”Ÿæˆä¸€ä¸ªçœŸæ­£attribute)ã€‚ è¿™é‡Œè®¾ç½®äº†secondAttribute,é‚£firstå“ªé‡Œè®¾ç½®å‘¢ï¼Ÿå›ä¸Šé¢çœ‹ä¸€ä¸‹makerç”Ÿäº§ç¬¬ä¸€ä¸ªçº¦æŸ(initWithFirstViewAttribute:viewAttribute),é‚£ä¼šè®¾ç½®äº†firstAttributeã€‚æœ€åçš„.offSetå°±æ˜¯è®¾ç½®çº¦æŸçš„constantçš„ï¼Œè¿”å›çº¦æŸæœ¬èº«ã€‚è¿™é‡Œæœ‰ä¸ªä¸æ˜ç™½ç‚¹ï¼Œè¿™é‡Œ.equalToä¸ºä»€ä¹ˆè¦é€šè¿‡blockæ¥è®¾ç½®ï¼Ÿåƒ.offSeté‚£æ ·ç›´æ¥ä¼ å…¥å‚æ•°ï¼Œè¿”å›selfï¼Œä¸ä¹Ÿå¯ä»¥ï¼Ÿçœ‹ç€æ²¡ä»€ä¹ˆå·®åˆ«ã€‚æä¸æ‡‚blockå¥½å¤„åœ¨å“ªâ€¦</p><p>å¦å¤–ï¼Œä»£ç å¯ä»¥çœ‹å‡ºattributeä¹Ÿå¯ä»¥æ˜¯æ•°ç»„ï¼Œå¯¹åº”make.top.equalTo(@[self.view, otherView])è¿™ç§ç”¨æ³•ï¼Œè¿™ç§ç”¨æ³•åˆ™ä¼šäº§ç”Ÿä¸€ä¸ªçº¦æŸé›†ã€‚å¯¹çº¦æŸé›†è°ƒç”¨.offSetæˆ–è€….equalTo, å°±æ˜¯å–å‡ºçº¦æŸé›†çš„æ¯ä¸€ä¸ªçº¦æŸï¼Œéƒ½å¤„ç†ä¸€éã€‚ä¸‹é¢æ¥çœ‹å¦ä¸€ç§æƒ…å†µï¼Œmake.left.right.top.equalTo(self.view)ã€‚</p><p>ä»ä¸Šåˆ†æå¾—make.leftäº§ç”Ÿä¸€ä¸ªfirstItemä¸ºleftAttributeçš„çº¦æŸï¼Œæ¥ä¸‹æ¥å°±æ˜¯â€çº¦æŸ.rightâ€ä¼šæ€æ ·ï¼Ÿç­”æ¡ˆæ˜¯ï¼Œç”Ÿæˆä¸€ä¸ªfirstItemä¸ºrightAttributeçš„çº¦æŸï¼Œ ä¸¤ä¸ªçº¦æŸåˆæˆä¸€ä¸ªçº¦æŸé›†ã€‚è§ä»£ç ï¼š</p><pre><code>- (MASConstraint *)right {    <span class="keyword">return</span> [<span class="keyword">self</span> addConstraintWithLayoutAttribute:<span class="built_in">NSLayoutAttributeRight</span>];}- (MASConstraint *)addConstraintWithLayoutAttribute:(<span class="built_in">NSLayoutAttribute</span>)layoutAttribute {    <span class="built_in">NSAssert</span>(!<span class="keyword">self</span><span class="variable">.hasLayoutRelation</span>, <span class="string">@"Attributes should be chained before defining the constraint relation"</span>);    <span class="keyword">return</span> [<span class="keyword">self</span><span class="variable">.delegate</span> constraint:<span class="keyword">self</span> addConstraintWithLayoutAttribute:layoutAttribute];}</code></pre><p>è¿™é‡Œself.delegateçš„å°±æ˜¯makerï¼Œç”¨makeråˆ›å»ºrightAttributeçº¦æŸï¼Œåˆæˆä¸€ä¸ªçº¦æŸé›†ã€‚makeråˆ›å»ºçº¦æŸä»£ç å·²ç»è´´åœ¨ä¸Šé¢ã€‚å†çœ‹ç»§ç»­.topä¼šæ€æ ·ï¼Œä»£ç ï¼š</p><pre><code>- (MASConstraint *)top {    return [<span class="keyword">self </span><span class="keyword">addConstraintWithLayoutAttribute:NSLayoutAttributeRight];</span>}- (MASConstraint *)<span class="keyword">addConstraintWithLayoutAttribute:(NSLayoutAttribute)layoutAttribute </span>{    [<span class="keyword">self </span>constraint:<span class="keyword">self </span><span class="keyword">addConstraintWithLayoutAttribute:layoutAttribute];</span>    return <span class="keyword">self;</span>}- (MASConstraint *)constraint:(MASConstraint __unused *)constraint <span class="keyword">addConstraintWithLayoutAttribute:(NSLayoutAttribute)layoutAttribute </span>{    id&lt;MASConstraintDelegate&gt; <span class="keyword">strongDelegate </span>= <span class="keyword">self.delegate;</span>    MASConstraint *newConstraint = [<span class="keyword">strongDelegate </span>constraint:<span class="keyword">self </span><span class="keyword">addConstraintWithLayoutAttribute:layoutAttribute];</span>    newConstraint.delegate = <span class="keyword">self;</span>    [<span class="keyword">self.childConstraints </span><span class="keyword">addObject:newConstraint];</span>    return newConstraint<span class="comment">;</span>}</code></pre><p>åŒæ ·è¿™é‡Œdelegateå°±æ˜¯makerï¼Œç”¨makeråˆ›å»ºä¸€ä¸ªçº¦æŸï¼ŒåŠ å…¥åˆ°è¿™ä¸ªçº¦æŸé›†ã€‚æœ€åmake.left.right.top.equalTo(self.view)ï¼Œ.equalToå°±æ˜¯ä»çº¦æŸé›†é‡Œä¸€ä¸ªä¸ªçº¦æŸæŠ“å‡ºæ¥.equalToä¸€ä¸‹å°±æ˜¯äº†ã€‚</p><p>æ€»ç»“ä¸€ä¸‹,å…±ä¸‰ä¸ªæ­¥éª¤ï¼š</p><ol><li>makerç”Ÿäº§çº¦æŸæˆ–çº¦æŸé›†ï¼Œæ–¹å¼æ˜¯â€maker.leftâ€æˆ–â€çº¦æŸ.rightâ€(ä¹Ÿå°±æ˜¯:make.left.right),çº¦æŸæ˜¯é€šè¿‡delegateè°ƒç”¨makerçš„ç”Ÿäº§æ–¹æ³•ã€‚</li><li>çº¦æŸä¿¡æ¯è®¾ç½®ï¼Œè®¾ç½®secondItem, layoutRelation, constant, priorityï¼Œçº¦æŸæœ¬èº«æä¾›çº¦æŸç›¸å…³ä¿¡æ¯è®¾ç½®æ–¹æ³•ï¼Œæ–¹å¼æ˜¯.equalTo, .offSet .priority, çº¦æŸé›†çš„ç›¸å…³ä¿¡æ¯è®¾ç½®å°±æ˜¯éå†å¤„ç†åŒ…å«çš„çº¦æŸã€‚</li><li>makerç”Ÿäº§å®Œçº¦æŸï¼Œinstall allå°±å®Œäº†ã€‚æ–¹å¼ï¼šmakerå­˜æœ‰æ‰€æœ‰è®¾ç½®çš„çº¦æŸï¼Œinstallæœ¬èº«çš„æ–¹æ³•åœ¨çº¦æŸç±»é‡Œï¼Œmakeréå†æ‰§è¡Œã€‚</li></ol><h2 id="é“¾å¼è°ƒç”¨è¯­æ³•å¦‚ä½•å®ç°ï¼Ÿ">é“¾å¼è°ƒç”¨è¯­æ³•å¦‚ä½•å®ç°ï¼Ÿ</h2><p>ä¸Šé¢çš„åˆ†æï¼Œé“¾å¼è¯­æ³•å¦‚ä½•å®ç°å·²ç»å¾ˆæ¸…æ™°äº†ã€‚.left .right. equalTo. offsetç­‰éƒ½ä¼šè¿”å›çº¦æŸæœ¬èº«æˆ–è€…ä¸€ä¸ªçº¦æŸé›†ã€‚çº¦æŸæˆ–çº¦æŸé›†åˆå¯ä»¥åšä¸‹ä¸€æ¬¡â€¦çš„é“¾å¼è°ƒç”¨ã€‚ä¿¡æ¯çš„è®¾ç½®æ–¹å¼æœ‰.offSet(@1),å°±ç›´æ¥ä¼ å€¼è¿›å»ï¼Œè¿˜æœ‰.equalTo,é€šè¿‡blockæ¥ä¼ ã€‚</p><h2 id="ä½¿ç”¨æ³¨æ„äº‹é¡¹ï¼Ÿ">ä½¿ç”¨æ³¨æ„äº‹é¡¹ï¼Ÿ</h2><p>å¤§é‡çš„Masonryä½¿ç”¨ï¼ŒåŸºæœ¬æ²¡å‡ºä»€ä¹ˆçŠ¶å†µï¼Œæ˜¯æ¯”è¾ƒç¨³å®šçš„ã€‚æœ‰ä¸¤ä¸ªå°é—®é¢˜è¦ç¨å¾®æ³¨æ„ä¸‹ã€‚</p><p>1ã€mas_updateConstraints,æœ‰é‡åˆ°è¿™ä¸ªæ²¡ç”Ÿæ•ˆçš„æƒ…å†µã€‚çœ‹ä¸€ä¸‹ä»£ç ï¼š</p><pre><code>- (<span class="keyword">void</span>)install {    ........æ­¤å¤„çœç•¥è‹¥å¹²ä»£ç ........    MASLayoutConstraint *existingConstraint = <span class="literal">nil</span>;    <span class="keyword">if</span> (<span class="keyword">self</span><span class="variable">.updateExisting</span>) {        existingConstraint = [<span class="keyword">self</span> layoutConstraintSimilarTo:layoutConstraint];    }    <span class="keyword">if</span> (existingConstraint) {        <span class="comment">// just update the constant</span>        existingConstraint<span class="variable">.constant</span> = layoutConstraint<span class="variable">.constant</span>;        <span class="keyword">self</span><span class="variable">.layoutConstraint</span> = existingConstraint;    } <span class="keyword">else</span> {        [<span class="keyword">self</span><span class="variable">.installedView</span> addConstraint:layoutConstraint];        <span class="keyword">self</span><span class="variable">.layoutConstraint</span> = layoutConstraint;        [firstLayoutItem<span class="variable">.mas_installedConstraints</span> addObject:<span class="keyword">self</span>];    }}- (MASLayoutConstraint *)layoutConstraintSimilarTo:(MASLayoutConstraint *)layoutConstraint {    <span class="comment">// check if any constraints are the same apart from the only mutable property constant</span>    <span class="comment">// go through constraints in reverse as we do not want to match auto-resizing or interface builder constraints</span>    <span class="comment">// and they are likely to be added first.</span>    <span class="keyword">for</span> (<span class="built_in">NSLayoutConstraint</span> *existingConstraint <span class="keyword">in</span> <span class="keyword">self</span><span class="variable">.installedView</span><span class="variable">.constraints</span><span class="variable">.reverseObjectEnumerator</span>) {        <span class="keyword">if</span> (![existingConstraint isKindOfClass:MASLayoutConstraint<span class="variable">.class</span>]) <span class="keyword">continue</span>;        <span class="keyword">if</span> (existingConstraint<span class="variable">.firstItem</span> != layoutConstraint<span class="variable">.firstItem</span>) <span class="keyword">continue</span>;        <span class="keyword">if</span> (existingConstraint<span class="variable">.secondItem</span> != layoutConstraint<span class="variable">.secondItem</span>) <span class="keyword">continue</span>;        <span class="keyword">if</span> (existingConstraint<span class="variable">.firstAttribute</span> != layoutConstraint<span class="variable">.firstAttribute</span>) <span class="keyword">continue</span>;        <span class="keyword">if</span> (existingConstraint<span class="variable">.secondAttribute</span> != layoutConstraint<span class="variable">.secondAttribute</span>) <span class="keyword">continue</span>;        <span class="keyword">if</span> (existingConstraint<span class="variable">.relation</span> != layoutConstraint<span class="variable">.relation</span>) <span class="keyword">continue</span>;        <span class="keyword">if</span> (existingConstraint<span class="variable">.multiplier</span> != layoutConstraint<span class="variable">.multiplier</span>) <span class="keyword">continue</span>;        <span class="keyword">if</span> (existingConstraint<span class="variable">.priority</span> != layoutConstraint<span class="variable">.priority</span>) <span class="keyword">continue</span>;        <span class="keyword">return</span> (<span class="keyword">id</span>)existingConstraint;    }    <span class="keyword">return</span> <span class="literal">nil</span>;}</code></pre><p>æ›´æ–°è¿‡ç¨‹ï¼šç»™ä¸ªæ ‡å¿—updateExistingï¼ŒYESä¸ºéœ€è¦æ›´æ–°ï¼Œéœ€è¦æ›´æ–°çš„è¯ï¼Œå°±å…ˆæ‰¾æœ‰æ²¡æœ‰ç›¸ä¼¼çš„çº¦æŸå­˜åœ¨ã€‚æœ‰ç›¸ä¼¼çš„çº¦æŸå°±æ›´æ–°çº¦æŸçš„constantã€‚æ²¡æœ‰ç›¸ä¼¼çº¦æŸå°±æ·»åŠ æ–°çš„çº¦æŸã€‚é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œé‚£å¦‚ä½•å®šä¹‰ç›¸ä¼¼ï¼Ÿçœ‹ä¸Šé¢ä»£ç ã€‚å°±æ˜¯firsetItem,secondItem,firstAttribute,secondAttribute,releation,multiplier,priorityéƒ½ç›¸ç­‰å°±å®šä¹‰ä¸ºç›¸ä¼¼ï¼Œåˆ™æ›´æ–°constantå³å¯ã€‚å¹³æ—¶ä½¿ç”¨æ—¶updateæ²¡ç”Ÿæ•ˆæ˜¯ä¸ªä»€ä¹ˆæƒ…å†µï¼Ÿå¾ˆæœ‰å¯èƒ½çš„å°±æ˜¯multiplier,priorityå˜äº†ï¼Œæˆ–è€…åŒæ ·æ•ˆæœçš„çº¦æŸç”¨äº†ä¸åŒæ–¹å¼ã€‚æ¯”å¦‚ï¼šwidthè®¾ç½®ï¼Œåˆå§‹è®¾ç½®æœ‰å¯èƒ½æ˜¯.equalTo(otherView), ç„¶åæ•°æ®æºå˜äº†ï¼Œéœ€è¦åˆ·æ–°å€¼ï¼Œæˆ‘ä»¬å°±ç†æ‰€å½“ç„¶çš„.equalTo(@55), è¿™æ ·ä»€ä¹ˆé—®é¢˜ï¼ŸsencondItemä¸ä¸€æ ·ï¼Œä¸ä»…ä¸æ˜¯updateï¼Œè¿˜å åŠ äº†ä¸€ä¸ªwidthçº¦æŸä¸Šå»,å¯¼è‡´å†²çªï¼Œç„¶åå°±æ‡µé€¼äº†ï¼Œwtfâ€¦..</p><p>2ã€å‘½åé—®é¢˜ã€‚view.left, view.centerX, æœ€å¥½ä¸è¦ç”¨è¿™ä¸ª, ç”¨view.mas_left, view.mas_centerXã€‚ è¿™ç§å‘½åå¾ˆå®¹æ˜“å†²çªï¼Œç»å¸¸ä¼šæœ‰ä¸€äº›åº“æˆ–è€…æˆ‘ä»¬è‡ªå·±çš„ä»£ç ï¼Œä¹Ÿç»™UIViewåŠ äº†category,ç”¨centerX,left,rightä»€ä¹ˆçš„æ¥å–viewçš„åæ ‡ã€‚è¿™ç§æ¯”è¾ƒé€šç”¨çš„å‘½åå°½é‡é¿å…ã€‚</p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;Overview&quot;&gt;Overview&lt;/h2&gt;&lt;p&gt;Masonryå·²ç»æ˜¯ç¦»ä¸å¼€çš„å¼€å‘åº“äº†ï¼Œæ‰€æœ‰å¸ƒå±€éƒ½ç”¨å®ƒï¼Œè®°å½•ä¸€ä¸‹&lt;a href=&quot;https://github.com/SnapKit/Masonry&quot;&gt;Masonary&lt;/a&gt;çš„æºç å­¦ä¹ ã€‚å¸¦ç€å‡ ä¸ªé—®é¢˜å¼€å§‹ã€‚&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Masonryæ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Ÿ&lt;/li&gt;
&lt;li&gt;é“¾å¼è°ƒç”¨çš„è¯­æ³•æ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿ&lt;/li&gt;
&lt;li&gt;ä½¿ç”¨æ³¨æ„é¡¹ï¼Ÿ&lt;/li&gt;
&lt;/ul&gt;
    
    </summary>
    
    
      <category term="masonry" scheme="https://github.com/zhuangxq/zhuangxq.github.io.git/tags/masonry/"/>
    
      <category term="è‡ªåŠ¨å¸ƒå±€" scheme="https://github.com/zhuangxq/zhuangxq.github.io.git/tags/%E8%87%AA%E5%8A%A8%E5%B8%83%E5%B1%80/"/>
    
      <category term="iOSæºç å­¦ä¹ " scheme="https://github.com/zhuangxq/zhuangxq.github.io.git/tags/iOS%E6%BA%90%E7%A0%81%E5%AD%A6%E4%B9%A0/"/>
    
  </entry>
  
  <entry>
    <title>iOSè®¾å¤‡å¦‚ä½•æ­£ç¡®è·å–è®¾å¤‡å¯åŠ¨æ—¶é—´ï¼Ÿ</title>
    <link href="https://github.com/zhuangxq/zhuangxq.github.io.git/2015/07/25/iOS%E8%AE%BE%E5%A4%87%E5%A6%82%E4%BD%95%E6%AD%A3%E7%A1%AE%E8%8E%B7%E5%8F%96%E8%AE%BE%E5%A4%87%E5%90%AF%E5%8A%A8%E6%97%B6%E9%97%B4%EF%BC%9F/"/>
    <id>https://github.com/zhuangxq/zhuangxq.github.io.git/2015/07/25/iOSè®¾å¤‡å¦‚ä½•æ­£ç¡®è·å–è®¾å¤‡å¯åŠ¨æ—¶é—´ï¼Ÿ/</id>
    <published>2015-07-25T02:17:13.000Z</published>
    <updated>2019-10-27T08:25:41.250Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Overview">Overview</h2><p>å‰æ®µæ—¶é—´äº§å“åŠŸèƒ½éœ€æ±‚éœ€è¦ç”¨åˆ°è®¾å¤‡å¯åŠ¨æ—¶é—´ã€‚æ‰¾äº†å‡ ç§æ–¹æ³•ï¼Œå‡ ç•ªå‘¨æŠ˜ç®—æ˜¯æ‰¾åˆ°æ»¡è¶³äº†éœ€æ±‚çš„æ–¹æ³•ã€‚æ­¤ç¯‡è®°å½•ä¸€ä¸‹å¦‚ä½•æ­£ç¡®å§¿åŠ¿è·å–è®¾å¤‡å¯åŠ¨æ—¶é—´ã€‚æ–¹æ³•4æ˜¯æ»¡è¶³æˆ‘éœ€æ±‚çš„è®¾å¤‡å¯åŠ¨æ—¶é—´ï¼Œå¯ç›´æ¥å‰å¾€ã€‚</p><a id="more"></a><h3 id="æ–¹æ³•1">æ–¹æ³•1</h3><p>å¾ˆå®¹æ˜“æ‰¾åˆ°è¿™ä¸ªæ–¹æ³•ï¼š<code>[NSProcessInfo processInfo].systemUptime</code>ã€‚</p><p>å®˜æ–¹æ–‡æ¡£ï¼š<em>The time interval since the computer was restarted. (read-only)</em>,<br>è®¾å¤‡é‡æ–°å¯åŠ¨åçš„è¿ç»­è¿è¡Œæ—¶é—´ã€‚ä¹ä¸€çœ‹å¾ˆå¥½ï¼Œæå®šã€‚å…¶å®è¿™ä¸ªæ¥å£æ ¹æœ¬å°±ä¸å‡†ã€‚ç”¨äº†è¿™ä¸ªæ¥å£ï¼Œä½ ä¼šå‘ç°å³ä½¿ä½ æ²¡æœ‰é‡æ–°å¯åŠ¨ï¼Œè®¾å¤‡å¯åŠ¨æ—¶é—´å´ä¸€ç›´æœ‰åœ¨å˜åŒ–ã€‚çŸ­æ—¶é—´å†…ä¼¼ä¹éƒ½æ˜¯å¯¹çš„ï¼Œä½†æ˜¯è®¾å¤‡å¯åŠ¨ä¸ªå‡ å¤©å°±æœ‰é—®é¢˜äº†ã€‚å…·ä½“åŸå› ä¸è¯¦ã€‚</p><h3 id="æ–¹æ³•2">æ–¹æ³•2</h3><pre><code><span class="preprocessor">#<span class="keyword">include</span> &lt;sys/types.h&gt;</span><span class="preprocessor">#<span class="keyword">include</span> &lt;sys/sysctl.h&gt; </span><span class="preprocessor">#<span class="keyword">define</span> MIB_SIZE 2  </span><span class="keyword">int</span> mib[MIB_SIZE];<span class="keyword">size_t</span> size;<span class="keyword">struct</span> timeval  boottime;mib[<span class="number">0</span>] = CTL_KERN;mib[<span class="number">1</span>] = KERN_BOOTTIME;size = <span class="keyword">sizeof</span>(boottime);<span class="keyword">if</span> (sysctl(mib, MIB_SIZE, &amp;boottime, &amp;size, NULL, <span class="number">0</span>) != -<span class="number">1</span>){    <span class="comment">// successful call</span>    NSDate* bootDate = [NSDate dateWithTimeIntervalSince1970:boottime.tv_sec];}</code></pre><p>ä¸Šé¢ä»£ç æ¥è‡ª<a href="http://stackoverflow.com/questions/10331020/get-the-boot-time-in-objective-c" target="_blank" rel="noopener">è¿™é‡Œ</a>ã€‚å…³é”®ä»£ç ä¸»è¦æ˜¯sysctlï¼Œç”¨æ¥è·å–æˆ–è®¾ç½®å†…æ ¸çŠ¶æ€çš„å‡½æ•°ã€‚sysctlåŠæ›´å¤šå†…æ ¸çŠ¶æ€ä¿¡æ¯<a href="https://developer.apple.com/library/mac/documentation/Darwin/Reference/ManPages/man8/sysctl.8.html" target="_blank" rel="noopener">æˆ³è¿™é‡Œ</a>ã€‚ä¸Šé¢ä»£ç å°±æ˜¯ç›´æ¥è¯»å–å†…æ ¸çŠ¶æ€ä¸­çš„è®¾å¤‡å¯åŠ¨æ—¶é—´ã€‚KERN_BOOTTIMEç‚¹å‡»è¿›å»å¤´æ–‡ä»¶æ˜¯è¿™æ ·æè¿°çš„ï¼š/<em> struct: time kernel was booted </em>/ã€‚å†…æ ¸å¯åŠ¨æ—¶é—´ï¼Œè¿™æ€»é è°±äº†å§ã€‚ç»éªŒè¯ï¼Œè¿™ä¸ªæ—¶é—´æ˜¯é è°±çš„ã€‚ä½†æ˜¯æœ‰ä¸ªé—®é¢˜ï¼Œå¦‚æœæ”¹äº†è®¾å¤‡æ—¶é—´ï¼Œè¿™ä¸ªé‡å¯æ—¶é—´å±…ç„¶ä¹Ÿè·Ÿç€å˜â€¦å¯è§ï¼Œè¿™ä¸ªå‚æ•°çš„è¿”å›å€¼æ˜¯æ ¹æ®å½“å‰è®¾å¤‡æ—¶é—´è®¡ç®—æ¥çš„ã€‚ä¸€äº›éœ€è¦å‡†ç¡®åˆ¤æ–­é‡å¯æ—¶é—´çš„é€»è¾‘ï¼Œæ˜¾ç„¶åœ¨æ”¹å˜è®¾å¤‡æ—¶é—´çš„çŠ¶å†µä¸‹å°±æœ‰é—®é¢˜äº†ã€‚æ‰€ä»¥ï¼Œä¸æ»¡è¶³è¦æ±‚â€¦</p><h3 id="æ–¹æ³•3">æ–¹æ³•3</h3><pre><code><span class="preprocessor">#include <span class="title">&lt;arpa/inet.h&gt;</span></span><span class="preprocessor">#include <span class="title">&lt;net/if.h&gt;</span></span><span class="preprocessor">#include <span class="title">&lt;ifaddrs.h&gt;</span></span><span class="preprocessor">#include <span class="title">&lt;net/if_dl.h&gt;</span></span><span class="built_in">BOOL</span>   success;<span class="keyword">struct</span> ifaddrs *addrs;<span class="keyword">const</span> <span class="keyword">struct</span> ifaddrs *cursor;<span class="keyword">const</span> <span class="keyword">struct</span> if_data *networkStatisc;<span class="built_in">NSString</span> *name=[[<span class="built_in">NSString</span> alloc]init];<span class="keyword">struct</span> IF_DATA_TIMEVAL changeTime ;success = getifaddrs(&amp;addrs) == <span class="number">0</span>;<span class="keyword">if</span> (success){    cursor = addrs;    <span class="keyword">while</span> (cursor != <span class="literal">NULL</span>)    {        name=[<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"%s"</span>,cursor-&gt;ifa_name];        <span class="keyword">if</span> (cursor-&gt;ifa_addr-&gt;sa_family == AF_LINK)        {            <span class="keyword">if</span> ([name hasPrefix:<span class="string">@"en1"</span>])            {                networkStatisc = (<span class="keyword">const</span> <span class="keyword">struct</span> if_data *) cursor-&gt;ifa_data;                changeTime = networkStatisc-&gt;ifi_lastchange;                <span class="built_in">NSDate</span> *restartTime = [<span class="built_in">NSDate</span> dateWithTimeIntervalSince1970:changeTime<span class="variable">.tv_sec</span>];            }            <span class="keyword">if</span> ([name hasPrefix:<span class="string">@"pdp_ip1"</span>])            {                networkStatisc = (<span class="keyword">const</span> <span class="keyword">struct</span> if_data *) cursor-&gt;ifa_data;                changeTime = networkStatisc-&gt;ifi_lastchange;                <span class="built_in">NSDate</span> *restartTime = [<span class="built_in">NSDate</span> dateWithTimeIntervalSince1970:changeTime<span class="variable">.tv_sec</span>];            }        }        cursor = cursor-&gt;ifa_next;    }    freeifaddrs(addrs);}</code></pre><p>ä¸Šé¢ä»£ç æ˜¯è·å–ç½‘ç»œæ¥å£æµé‡æ”¹å˜æ—¶é—´ã€‚ enå¼€å¤´çš„æ˜¯WiFiç½‘å£ï¼Œpdp_ipå¼€å¤´çš„æ˜¯ç§»åŠ¨æµé‡ç½‘å£ã€‚æœ‰ç”¨åˆ°çš„æ˜¯en0,å’Œpdp_ip0,å…¶ä»–éƒ½æ˜¯æ²¡ç”¨çš„ï¼ˆå…¶å®æ˜¯ä¸çŸ¥é“å®ƒä»€ä¹ˆæ—¶å€™ä¼šç”¨åˆ°â€¦ï¼‰ã€‚è®¾å¤‡é‡å¯ä¼šé‡ç½®ç½‘ç»œæ¥å£çš„æ•°æ®ï¼Œifi_lastchangeå°±ä¼šæ›´æ–°ä¸ºé‡å¯çš„æ—¶é—´ã€‚å¯¹äºen1ã€pdp_ip1å°±åªåœ¨è®¾å¤‡é‡å¯çš„æ—¶å€™æ”¹å˜ï¼Œå°±å¯ä»¥ä½œä¸ºè®¾å¤‡é‡å¯æ—¶é—´ã€‚å¯æƒœçš„æ˜¯ï¼Œå­˜åœ¨ä¸æ–¹æ³•2åŒæ ·çš„é—®é¢˜ï¼Œæ‰€ä»¥ï¼Œä¸æ»¡è¶³éœ€æ±‚â€¦</p><h3 id="æ–¹æ³•4">æ–¹æ³•4</h3><pre><code><span class="keyword">int</span> mib[<span class="number">4</span>] = {CTL_KERN, KERN_PROC, KERN_PROC_ALL, <span class="number">0</span>};size_t miblen = <span class="number">4</span>;size_t size;<span class="keyword">int</span> st = sysctl(mib, miblen, <span class="literal">NULL</span>, &amp;size, <span class="literal">NULL</span>, <span class="number">0</span>);<span class="keyword">struct</span> kinfo_proc * process = <span class="literal">NULL</span>;<span class="keyword">struct</span> kinfo_proc * newprocess = <span class="literal">NULL</span>;<span class="keyword">do</span> {    size += size / <span class="number">10</span>;    newprocess = realloc(process, size);    <span class="keyword">if</span> (!newprocess){       <span class="keyword">if</span> (process)        {            free(process);        }        <span class="keyword">return</span> <span class="literal">nil</span>;    }    process = newprocess;    st = sysctl(mib, miblen, process, &amp;size, <span class="literal">NULL</span>, <span class="number">0</span>);} <span class="keyword">while</span> (st == -<span class="number">1</span> &amp;&amp; errno == ENOMEM);<span class="keyword">if</span> (st == <span class="number">0</span>){    <span class="keyword">if</span> (size % <span class="keyword">sizeof</span>(<span class="keyword">struct</span> kinfo_proc) == <span class="number">0</span>){        <span class="keyword">int</span> nprocess = size / <span class="keyword">sizeof</span>(<span class="keyword">struct</span> kinfo_proc);        <span class="keyword">if</span> (nprocess)            {            <span class="built_in">NSMutableArray</span> * array = [[<span class="built_in">NSMutableArray</span> alloc] init];            <span class="keyword">for</span> (<span class="keyword">int</span> i = nprocess - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--)            {                <span class="built_in">NSString</span> * processID = [[<span class="built_in">NSString</span> alloc] initWithFormat:<span class="string">@"%d"</span>, process[i]<span class="variable">.kp_proc</span><span class="variable">.p_pid</span>];                <span class="built_in">NSString</span> * processName = [[<span class="built_in">NSString</span> alloc]initWithBytes:(<span class="keyword">const</span> <span class="keyword">void</span> *)process[i]<span class="variable">.kp_proc</span><span class="variable">.p_comm</span>                                                                 length:strlen(process[i]<span class="variable">.kp_proc</span><span class="variable">.p_comm</span>)                                                               encoding:<span class="built_in">NSUTF8StringEncoding</span>];               <span class="keyword">if</span> ([processName isEqualToString:<span class="string">@"kernel_task"</span>])                 {                    <span class="built_in">NSTimeInterval</span> time = process[i]<span class="variable">.kp_proc</span><span class="variable">.p_un</span><span class="variable">.__p_starttime</span><span class="variable">.tv_sec</span>;                    ;                }            }            free(process);            <span class="keyword">return</span> array;        }    }}    </code></pre><p>ä¸Šé¢ä»£ç åšä¿©ä¸ªäº‹ï¼š1ã€è·å–æ­£åœ¨è¿è¡Œè¿›ç¨‹åˆ—è¡¨ã€‚2ã€æ‰¾åˆ°kernel_taskè¿›ç¨‹ï¼Œkernel_taskè¿›ç¨‹çš„å¯åŠ¨æ—¶é—´å°±å¯ä½œä¸ºè®¾å¤‡é‡å¯çš„æ—¶é—´ã€‚ç»æµ‹è¯•ï¼Œæ²¡æœ‰æ–¹æ³•2ã€3çš„é—®é¢˜ã€‚æ»¡è¶³è¦æ±‚ã€‚</p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;Overview&quot;&gt;Overview&lt;/h2&gt;&lt;p&gt;å‰æ®µæ—¶é—´äº§å“åŠŸèƒ½éœ€æ±‚éœ€è¦ç”¨åˆ°è®¾å¤‡å¯åŠ¨æ—¶é—´ã€‚æ‰¾äº†å‡ ç§æ–¹æ³•ï¼Œå‡ ç•ªå‘¨æŠ˜ç®—æ˜¯æ‰¾åˆ°æ»¡è¶³äº†éœ€æ±‚çš„æ–¹æ³•ã€‚æ­¤ç¯‡è®°å½•ä¸€ä¸‹å¦‚ä½•æ­£ç¡®å§¿åŠ¿è·å–è®¾å¤‡å¯åŠ¨æ—¶é—´ã€‚æ–¹æ³•4æ˜¯æ»¡è¶³æˆ‘éœ€æ±‚çš„è®¾å¤‡å¯åŠ¨æ—¶é—´ï¼Œå¯ç›´æ¥å‰å¾€ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="iOS" scheme="https://github.com/zhuangxq/zhuangxq.github.io.git/tags/iOS/"/>
    
      <category term="è®¾å¤‡å¯åŠ¨æ—¶é—´" scheme="https://github.com/zhuangxq/zhuangxq.github.io.git/tags/%E8%AE%BE%E5%A4%87%E5%90%AF%E5%8A%A8%E6%97%B6%E9%97%B4/"/>
    
  </entry>
  
  <entry>
    <title>å¼€ç¯‡ï¼</title>
    <link href="https://github.com/zhuangxq/zhuangxq.github.io.git/2015/07/07/%E5%BC%80%E7%AF%87%EF%BC%81/"/>
    <id>https://github.com/zhuangxq/zhuangxq.github.io.git/2015/07/07/å¼€ç¯‡ï¼/</id>
    <published>2015-07-07T13:37:17.000Z</published>
    <updated>2015-07-07T15:01:14.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="æ€»ç®—å¯ä»¥å†™ä¸Šä¸œè¥¿äº†ã€‚">æ€»ç®—å¯ä»¥å†™ä¸Šä¸œè¥¿äº†ã€‚</h2><p>   èŠ±äº†ä¸€ä¸ªæ™šä¸Šéƒ¨ç½²ï¼ŒåŠä¸ªæ™šä¸Šæ¢ä¸»é¢˜æ”¹ä¸ƒæ”¹å…«ï¼Œhexoé—®é¢˜è¿˜æ˜¯å¾ˆå¤šå•Šã€‚ä¸è¿‡æƒ³æƒ³hexoæ¥è‡ªäºå­¦ç”Ÿä¹‹æ‰‹ï¼Œä¹Ÿæ˜¯å¼å¾—ä¸è¡Œå•Šã€‚æ­ä¸ªblogå¥½åƒåå¹´å‰åœ¨ç©QQç©ºé—´ä¼¼çš„ï¼Œå¥½ç©ï¼æ„Ÿè°¢hexoä½œè€…ï¼Œæ„Ÿè°¢yilliaä¸»é¢˜ä½œè€…ã€‚è¿™é‡Œå°±ç”¨æ¥è®°å½•å­¦ä¹ æˆé•¿çš„ç‚¹æ»´äº†ï¼ˆMarkdownèµ¶ç´§ç†Ÿæ‚‰ä¸€ä¸‹-ã€‚-ï¼‰ã€‚ç©çš„æ„‰å¿«~ï¼</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;æ€»ç®—å¯ä»¥å†™ä¸Šä¸œè¥¿äº†ã€‚&quot;&gt;æ€»ç®—å¯ä»¥å†™ä¸Šä¸œè¥¿äº†ã€‚&lt;/h2&gt;&lt;p&gt;   èŠ±äº†ä¸€ä¸ªæ™šä¸Šéƒ¨ç½²ï¼ŒåŠä¸ªæ™šä¸Šæ¢ä¸»é¢˜æ”¹ä¸ƒæ”¹å…«ï¼Œhexoé—®é¢˜è¿˜æ˜¯å¾ˆå¤šå•Šã€‚ä¸è¿‡æƒ³æƒ³hexoæ¥è‡ªäºå­¦ç”Ÿä¹‹æ‰‹ï¼Œä¹Ÿæ˜¯å¼å¾—ä¸è¡Œå•Šã€‚æ­ä¸ªblogå¥½åƒåå¹´å‰åœ¨ç©QQç©ºé—´ä¼¼çš„ï¼Œå¥½ç©ï¼æ„Ÿè°¢hexoä½œè€…ï¼Œæ„Ÿè°¢yilliaä¸»é¢˜
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>Hello World</title>
    <link href="https://github.com/zhuangxq/zhuangxq.github.io.git/2015/07/06/hello-world/"/>
    <id>https://github.com/zhuangxq/zhuangxq.github.io.git/2015/07/06/hello-world/</id>
    <published>2015-07-06T13:20:49.000Z</published>
    <updated>2015-07-06T13:20:49.000Z</updated>
    
    <content type="html"><![CDATA[<p>Welcome to <a href="http://hexo.io/" target="_blank" rel="noopener">Hexo</a>! This is your very first post. Check <a href="http://hexo.io/docs/" target="_blank" rel="noopener">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="http://hexo.io/docs/troubleshooting.html" target="_blank" rel="noopener">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p><h2 id="Quick_Start">Quick Start</h2><h3 id="Create_a_new_post">Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">"My New Post"</span></span><br></pre></td></tr></table></figure><p>More info: <a href="http://hexo.io/docs/writing.html" target="_blank" rel="noopener">Writing</a></p><h3 id="Run_server">Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure><p>More info: <a href="http://hexo.io/docs/server.html" target="_blank" rel="noopener">Server</a></p><h3 id="Generate_static_files">Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure><p>More info: <a href="http://hexo.io/docs/generating.html" target="_blank" rel="noopener">Generating</a></p><h3 id="Deploy_to_remote_sites">Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure><p>More info: <a href="http://hexo.io/docs/deployment.html" target="_blank" rel="noopener">Deployment</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;Welcome to &lt;a href=&quot;http://hexo.io/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Hexo&lt;/a&gt;! This is your very first post. Check &lt;a href=&quot;http://hexo.io
      
    
    </summary>
    
    
  </entry>
  
</feed>
